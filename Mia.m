function Mia(~,~)
global UserValues MIAData
h.Mia=findobj('Tag','Mia');


if isempty(h.Mia)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Figure generation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Loads user profile
    LSUserValues(0);
    %%% To save typing
    Look=UserValues.Look;
    %%% Generates the Mia figure
    h.Mia = figure(...
        'Units','normalized',...
        'Tag','Mia',...
        'Name','MIA: Microtime image analysis',...
        'NumberTitle','off',...
        'Menu','none',...
        'defaultUicontrolFontName','Times',...
        'defaultAxesFontName','Times',...
        'defaultTextFontName','Times',...
        'Toolbar','figure',...
        'UserData',[],...
        'OuterPosition',[0.01 0.1 0.98 0.9],...
        'CloseRequestFcn',@Close_Mia,...
        'Visible','on');
    %h.Mia.Visible='off';
    h.Text=[];
    
    %%% Sets background of axes and other things
    whitebg(Look.Axes);
    %%% Changes Pam background; must be called after whitebg
    h.Mia.Color=Look.Back;
    
    %%% Menu to load mia data
    h.Mia_Load = uimenu(...
    'Parent',h.Mia,...
    'Label','Load...',...
    'Tag','Load_Mia');
    %%% Load TIFF
    h.Mia_Load_TIFF_Single = uimenu(...
    'Parent',h.Mia_Load,...
    'Label','...single color TIFFs',...
    'Callback',{@Mia_Load,1},...
    'Tag','Load_Mia_TIFF_SIngle');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Progressbar and file names %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%% Panel for progressbar
    h.Mia_Progress_Panel = uibuttongroup(...
        'Parent',h.Mia,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0.001 0.98 0.998 0.02]);
    %%% Axes for progressbar
    h.Mia_Progress_Axes = axes(...
        'Parent',h.Mia_Progress_Panel,...
        'Units','normalized',...
        'Color',Look.Control,...
        'Position',[0 0 1 1]);
    h.Mia_Progress_Axes.XTick=[]; h.Mia_Progress_Axes.YTick=[];
    %%% Progress and filename text
    h.Mia_Progress_Text=text(...
        'Parent',h.Mia_Progress_Axes,...
        'Units','normalized',...
        'FontSize',12,...
        'FontWeight','bold',...
        'String','Nothing loaded',...
        'Interpreter','none',...
        'HorizontalAlignment','center',...
        'BackgroundColor','none',...
        'Color',Look.Fore,...
        'Position',[0.5 0.5]);
%% Main tab container %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    h.Mia_Main_Tabs = uitabgroup(...
        'Parent',h.Mia,...
        'Tag','Mia_Main_Tabs',...
        'Units','normalized',...
        'Position',[0 0 1 0.98]);    
    %% Image Tab
    h.Mia_Image_Tab = uitab(...
        'Parent',h.Mia_Main_Tabs,...
        'Title','Image',...
        'Tag','Mia_Main_Tabs',...
        'Units','normalized');   
    h.Mia_Image_Panel = uibuttongroup(...
        'Parent',h.Mia_Image_Tab,...
        'Tag','Mia_Main_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 0.8 1]);   
    for i=1:2
        %%% Text
        h.Text{end+1} = handle(uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'FontWeight','Bold',...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.01 1.39-0.49*i, 0.11 0.03],...
            'String',['Channel ' num2str(i)]));
        %%% Colormap selection for images
        h.Mia_Image_Colormap(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'UserData',[mod(i-1,2) mod(i,2) 0],...
            'Callback',{@Update_Plots,1,i},...
            'ButtonDownFcn',{@Mia_Color,i},...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.12 1.39-0.49*i, 0.08 0.03],...
            'String',{'Gray','Jet','Hot','HSV','Custom'});
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.01 1.34-0.49*i, 0.11 0.03],...
            'String','PIE channel:');
        %%% Colormap selection for images
        h.Mia_PIE(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Value',min([i,numel(UserValues.PIE.Name)]),...
            'Position',[0.12 1.34-0.49*i, 0.08 0.03],...
            'String',UserValues.PIE.Name);
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.01 1.3-0.49*i, 0.05 0.03],...
            'String','Frame:');
        %%% Editbox for frame
        h.Mia_Frame(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Callback',{@Mia_Frame,1,i},...
            'Position',[0.065 1.3-0.49*i, 0.04 0.03],...
            'String','1');
        %%% Slider for frame
        h.Mia_Frame_Slider(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','slider',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'UserData',[2,i],...
            'Position',[0.11 1.3-0.49*i, 0.09 0.03]);
        h.Mia_Frame_Listener(i)=addlistener(h.Mia_Frame_Slider(i),'Value','PostSet',@Mia_Frame);  
        %%% Editbox for frame
        h.Mia_FrameUse(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','checkbox',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Callback',{@Mia_UseFrame,i},...
            'Value',1,...
            'Position',[0.205 1.3-0.49*i, 0.05 0.03],...
            'String','Use');        
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.01 1.26-0.49*i, 0.11 0.03],...
            'String','Second plot:');
        %%% Popupmenu to select what to plot in second plot
        h.Mia_Second(i) = uicontrol(...
            'Parent',h.Mia_Image_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.12 1.26-0.49*i, 0.08 0.03],...
            'Callback',{@Update_Plots,1,i},...
            'Value',2,...
            'String',{'Original','Dynamic','Static'});        
        %%% Checkbox to link channels
        if i==1
            h.Mia_Image_Link = uicontrol(...
                'Parent',h.Mia_Image_Panel,...
                'Style','checkbox',...
                'Units','normalized',...
                'FontSize',14,...
                'Callback',{@Mia_Frame,2,1},...
                'BackgroundColor', Look.Back,...
                'ForegroundColor', Look.Fore,...
                'Position',[0.01 0.73, 0.15 0.03],...
                'Value',1,...
                'String','Link channels');
        end
       
        %%% Axes to display images
        h.Mia_Image_Axes(i,1)= axes(...
            'Parent',h.Mia_Image_Panel,...
            'Units','normalized',...
            'Position',[0.28 0.99-0.49*i 0.35 0.48]);
        h.Mia_Image_Axes(i,2)= axes(...
            'Parent',h.Mia_Image_Panel,...
            'Units','normalized',...
            'Position',[0.64 0.99-0.49*i 0.35 0.48]);

        %%% Initializes empty plots
        h.Plots.Image(i,1)=image(zeros(1,1,3),...
            'Parent',h.Mia_Image_Axes(i,1),...
            'ButtonDownFcn',{@Mia_ROI,2});
        h.Mia_Image_Axes(i,1).DataAspectRatio=[1 1 1];
        h.Mia_Image_Axes(i,1).XTick=[];
        h.Mia_Image_Axes(i,1).YTick=[];
        h.Plots.Image(i,2)=image(zeros(1,1,3),...
            'Parent',h.Mia_Image_Axes(i,2));
        h.Mia_Image_Axes(i,2).DataAspectRatio=[1 1 1];
        h.Mia_Image_Axes(i,2).XTick=[];
        h.Mia_Image_Axes(i,2).YTick=[];
        %%% Initializes a rectangle ROI
        h.Plots.ROI(i)=rectangle(...
            'Parent',h.Mia_Image_Axes(i,1),...
            'Position',[0.5 0.5 1 1],...
            'EdgeColor',[1 1 1],...
            'HitTest','off');
        
        
    end         
        %% Settings Tab container
    h.Mia_Settings_Panel = uibuttongroup(...
        'Parent',h.Mia_Image_Tab,...
        'Tag','Mia_Settings_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0.8 0.5 0.2 0.5]);
    h.Mia_Settings_Tabs = uitabgroup(...
        'Parent',h.Mia_Settings_Panel,...
        'Tag','Mia_Settings_Tabs',...
        'Units','normalized',...
        'Position',[0 0 1 1]);
            %% Mia image settings tab
        %%% Tab and panel for Mia image settings UIs
        h.Mia_Image_Settings_Tab= uitab(...
        'Parent',h.Mia_Settings_Tabs,...
        'Tag','MI_Image_Tab',...
        'Title','Image');
        h.Mia_Image_Settings_Panel = uibuttongroup(...
        'Parent',h.Mia_Image_Settings_Tab,...
        'Tag','Mia_Image_Settings_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);
       
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',12,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.92, 0.4 0.06],...
            'String','Frame time [s]:');
        %%% Editbox to set frame time
        h.Mia_Image_Frame = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.45 0.92, 0.2 0.06],...
            'String','1');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',12,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.84, 0.4 0.06],...
            'String','Line time [ms]:');
        %%% Editbox to set line time
        h.Mia_Image_Line = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.45 0.84, 0.2 0.06],...
            'String','3.333');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',12,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.76, 0.4 0.06],...
            'String','Pixel time [µs]:');
        %%% Editbox to set pixel time
        h.Mia_Image_Pixel = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.45 0.76, 0.2 0.06],...
            'String','11.11');
                %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',12,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.68, 0.4 0.06],...
            'String','Pixel size [nm]:');
        %%% Editbox to set pixel size
        h.Mia_Image_Size = uicontrol(...
            'Parent',h.Mia_Image_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.45 0.68, 0.2 0.06],...
            'String','40');
            %% Mia ROI setting tab
        %%% Tab and panel for Mia ROI settings UIs
        h.Mia_ROI_Settings_Tab= uitab(...
            'Parent',h.Mia_Settings_Tabs,...
            'Tag','MI_ROI_Settings_Tab',...
            'Title','ROI');
        h.Mia_ROI_Settings_Panel = uibuttongroup(...
            'Parent',h.Mia_ROI_Settings_Tab,...
            'Tag','Mia_ROI_Settings_Panel',...
            'Units','normalized',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HighlightColor', Look.Control,...
            'ShadowColor', Look.Shadow,...
            'Position',[0 0 1 1]);
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.92, 0.35 0.06],...
            'String','ROI size:');
        %%% Popupmenu to select what to subtract
        h.Mia_ROI_SizeX = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.35 0.92, 0.25 0.06],...
            'Callback',{@Mia_ROI,1},...
            'String','200');
        %%% Popupmenu to select what to subtract
        h.Mia_ROI_SizeY = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.62 0.92, 0.25 0.06],...
            'Callback',{@Mia_ROI,1},...
            'String','200');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.84, 0.35 0.06],...
            'String','ROI pos:');
        %%% Popupmenu to select what to subtract
        h.Mia_ROI_PosX = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.35 0.84, 0.25 0.06],...
            'Callback',{@Mia_ROI,1},...
            'String','0');
        %%% Popupmenu to select what to subtract
        h.Mia_ROI_PosY = uicontrol(...
            'Parent',h.Mia_ROI_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.62 0.84, 0.25 0.06],...
            'Callback',{@Mia_ROI,1},...
            'String','0');
            %% Mia correction tab 
        %%% Tab and panel for Mia image correction settings UIs
        h.Mia_Correction_Settings_Tab= uitab(...
            'Parent',h.Mia_Settings_Tabs,...
            'Tag','MI_Correction_SettingsTab',...
            'Title','Correction');
        h.Mia_Correction_Settings_Panel = uibuttongroup(...
            'Parent',h.Mia_Correction_Settings_Tab,...
            'Tag','Mia_Correction_Settings_Panel',...
            'Units','normalized',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HighlightColor', Look.Control,...
            'ShadowColor', Look.Shadow,...
            'Position',[0 0 1 1]);    
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.92, 0.3 0.06],...
            'String','Subtract:');
        %%% Popupmenu to select what to subtract
        h.Mia_Subtract = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.34 0.92, 0.64 0.06],...
            'Callback',@Mia_Correct,...
            'String',{'Nothing','Frame mean','Pixel mean','Moving average'});
        %%% Text
        h.Mia_Subtract_Pixel_Text = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.84, 0.25 0.06],...
            'Visible','off',...
            'String','Pixel:');
        %%% Pixels to average for subtracting moving average
        h.Mia_Subtract_Pixel = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.27 0.84, 0.15 0.06],...
            'Callback',@Mia_Correct,...
            'Visible','off',...
            'String',1);
        %%% Text
        h.Mia_Subtract_Frames_Text = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.52 0.84, 0.28 0.06],...
            'Visible','off',...
            'String','Frames:');
        %%% Pixels to average for subtracting moving average
        h.Mia_Subtract_Frames = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.83 0.84, 0.15 0.06],...
            'Callback',@Mia_Correct,...
            'Visible','off',...
            'String',3);   
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.7, 0.3 0.06],...
            'String','Add:');
        %%% Popupmenu to select what to subtract
        h.Mia_Add = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.34 0.7, 0.64 0.06],...
            'Callback',@Mia_Correct,...
            'String',{'Nothing','Total mean','Frame mean','Pixel mean','Moving average'});
        %%% Text
        h.Mia_Add_Pixel_Text = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.62, 0.25 0.06],...
            'Visible','off',...
            'String','Pixel:');
        %%% Pixels to average for subtracting moving average
        h.Mia_Add_Pixel = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.27 0.62, 0.15 0.06],...
            'Callback',@Mia_Correct,...
            'Visible','off',...
            'String',1);
        %%% Text
        h.Mia_Add_Frames_Text = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.52 0.62, 0.28 0.06],...
            'Visible','off',...
            'String','Frames:');
        %%% Pixels to average for subtracting moving average
        h.Mia_Add_Frames = uicontrol(...
            'Parent',h.Mia_Correction_Settings_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.83 0.62, 0.15 0.06],...
            'Callback',@Mia_Correct,...
            'Visible','off',...
            'String',3);   
        %% Calculations tab container
        h.Mia_Calculations_Panel = uibuttongroup(...
            'Parent',h.Mia_Image_Tab,...
            'Tag','Mia_Calculations_Panel',...
            'Units','normalized',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HighlightColor', Look.Control,...
            'ShadowColor', Look.Shadow,...
            'Position',[0.8 0 0.2 0.5]);
        h.Mia_Calculations_Tabs = uitabgroup(...
            'Parent',h.Mia_Calculations_Panel,...
            'Tag','Mia_Calculations_Tabs',...
            'Units','normalized',...
            'Position',[0 0 1 1]);
            %% Perform correlation tab
        %%% Tab and panel for perform correlation UIs
        h.Mia_Calculations_Cor_Tab= uitab(...
            'Parent',h.Mia_Calculations_Tabs,...
            'Tag','MI_Image_Tab',...
            'Title','Correlate');
        h.Mia_Calculations_Cor_Panel = uibuttongroup(...
            'Parent',h.Mia_Calculations_Cor_Tab,...
            'Tag','Mia_Calculations_Cor_Panel',...
            'Units','normalized',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HighlightColor', Look.Control,...
            'ShadowColor', Look.Shadow,...
            'Position',[0 0 1 1]);
        %%% Button to start correlation
        h.Mia_Do_Correlation = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','push',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.92, 0.96 0.06],...
            'Callback',@Do_2D_XCor,...
            'String','Correlate');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.84, 0.5 0.06],...
            'String','Frames to use:');
        %%% Editbox to select, which frames to correlate
        %%% Put it to ROI?
        h.Mia_Correlation_Frames = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.53 0.84, 0.3 0.06],...
            'String','1');
        %%% Select, what to correlate
        h.Mia_Correlation_Type = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.76, 0.3 0.06],...
            'String',{'ACF1','ACF2','CCF'});
        %%% Select unselection criteria
        h.Mia_Correlation_FramesUse = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.34 0.76, 0.64 0.06],...
            'String',{'Use all frames','Use selected frames','Arbitrary region ICS'});
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.62, 0.56 0.11],...
            'String','Arbitrary region threshold');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.56 0.62, 0.2 0.06],...
            'String','MIN');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.78 0.62, 0.2 0.06],...
            'String','MAX');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min\max pixel countrate' 10 'averaged over all frames'],...
            'Position',[0.02 0.54, 0.72 0.06],...
            'String','Intensity [kHz]:'); 
        %%% Minimal average pixel countrate
        h.Mia_Correlation_Int_Min = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min pixel countrate' 10 'averaged over all frames'],...
            'Position',[0.56 0.54, 0.2 0.06],...
            'String','10');
        %%% Maximal average pixel countrate
        h.Mia_Correlation_Int_Max = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies max pixel countrate' 10 'averaged over all frames'],...
            'Position',[0.78 0.54, 0.2 0.06],...
            'String','1000');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies the sliding windows used' 10 'for intensity\variance thresholding' 10 'for arbitrary region ICS'],...
            'Position',[0.02 0.46, 0.72 0.06],...
            'String','Subregions [px]:');  
        %%% Smaller subregion
        h.Mia_Correlation_Sub1 = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies the smaller sliding window used' 10 'for intensity\variance thresholding' 10 'for arbitrary region ICS'],...
            'Position',[0.56 0.46, 0.2 0.06],...
            'String','10');
        %%% Larger subregion
        h.Mia_Correlation_Sub2 = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies the larger sliding window used' 10 'for intensity\variance thresholding' 10 'for arbitrary region ICS'],...
            'Position',[0.78 0.46, 0.2 0.06],...
            'String','30');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min\max intensity ratio' 10 'of subregions specified above'],...
            'Position',[0.02 0.38, 0.72 0.06],...
            'String','Intensity [Fold]:');  
        %%% Minimal intensity ratio of subregions
        h.Mia_Correlation_Int_Fold_Min = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min intensity ratio' 10 'of subregions specified above'],...
            'Position',[0.56 0.38, 0.2 0.06],...
            'String','0.6');
        %%% Maximal intensity ratio of subregions
        h.Mia_Correlation_Int_Fold_Max = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies max intensity ratio' 10 'of subregions specified above'],...
            'Position',[0.78 0.38, 0.2 0.06],...
            'String','1.5');
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',14,...
            'HorizontalAlignment','left',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min\max variance ratio' 10 'of subregions specified above'],...
            'Position',[0.02 0.3, 0.72 0.06],...
            'String','Variance [Fold]:');  
        %%% Minimal variance ratio of subregions
        h.Mia_Correlation_Var_Fold_Min = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies min variance ratio' 10 'of subregions specified above'],...
            'Position',[0.56 0.3, 0.2 0.06],...
            'String','0.7');
        %%% Maximal variance ratio of subregions
        h.Mia_Correlation_Var_Fold_Max = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',14,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'TooltipString',['Specifies max variance ratio' 10 'of subregions specified above'],...
            'Position',[0.78 0.3, 0.2 0.06],...
            'String','1.2');        
        %%% Selects data saving procedure
        h.Mia_Correlation_Save = uicontrol(...
            'Parent', h.Mia_Calculations_Cor_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.22, 0.64 0.06],...
            'String',{'Do not save','Save as .miacor','Save as TIFF'});
        
            %% Perform N&B calculation tab
        %%% Tab and panel for perform correlation UIs
        h.Mia_Calculations_NB_Tab= uitab(...
            'Parent',h.Mia_Calculations_Tabs,...
            'Title','Do N&B');
        h.Mia_Calculations_NB_Panel = uibuttongroup(...
            'Parent',h.Mia_Calculations_NB_Tab,...
            'Units','normalized',...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'HighlightColor', Look.Control,...
            'ShadowColor', Look.Shadow,...
            'Position',[0 0 1 1]);
        %%% Button to start N&B calculation
        h.Mia_Do_NB = uicontrol(...
            'Parent', h.Mia_Calculations_NB_Panel,...
            'Style','push',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.92, 0.96 0.06],...
            'Callback',@Do_NB,...
            'String','Callculate N&B');
        %%% Popupmenu to select for which channels to calculate
        h.Mia_NB_Type = uicontrol(...
            'Parent', h.Mia_Calculations_NB_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.84, 0.4 0.06],...
            'String',{'Channel1','Channel2','Cross'});
        %%% Popupmenu to select averaging style
        h.Mia_NB_Average = uicontrol(...
            'Parent', h.Mia_Calculations_NB_Panel,...
            'Style','popupmenu',...
            'Units','normalized',...
            'FontSize',12,...
            'Value',2,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.02 0.76, 0.4 0.06],...
            'String',{'None','Average','Disk','Gaussian'});
        %%% Text
        h.Text{end+1} = uicontrol(...
            'Parent', h.Mia_Calculations_NB_Panel,...
            'Style','text',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.44 0.745, 0.26 0.06],...
            'String','Diameter:');
        %%% Editbox for Averaging radius
        h.Mia_NB_Average_Diameter = uicontrol(...
            'Parent', h.Mia_Calculations_NB_Panel,...
            'Style','edit',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Control,...
            'ForegroundColor', Look.Fore,...
            'Position',[0.72 0.75, 0.15 0.06],...
            'String','3');
        
    %% Correlation Tab
    h.Mia_Cor_Tab = uitab(...
        'Parent',h.Mia_Main_Tabs,...
        'Title','Correlation',...
        'Tag','Mia_Cor_Tabs',...
        'Units','normalized');   
    h.Mia_Cor_Panel = uibuttongroup(...
        'Parent',h.Mia_Cor_Tab,...
        'Tag','Mia_Cor_Panel',...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);
    
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.01 0.95, 0.045 0.03],...
        'String','Size');
    %%% Editbox for correlation size
    h.Mia_Cor_Size = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',{@Update_Plots,2,1:3},...
        'Position',[0.06 0.95, 0.03 0.03],...
        'String','31');    
    %%% Colormap selection for correlations
    h.Cor_Colormap = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'UserData',[1 0 0],...
        'Callback',{@Update_Plots,2,1:3},...
        'ButtonDownFcn',{@Mia_Color,1},...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Value',2,...
        'Position',[0.1 0.95, 0.08 0.03],...
        'String',{'Gray','Jet','Hot','HSV','Custom'});
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.01 0.91, 0.045 0.03],...
        'String','Frame:');
    %%% Editbox for frame
    h.Mia_Cor_Frame = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',{@Mia_Frame,3,1:3},...
        'Position',[0.06 0.91, 0.03 0.03],...
        'String','0');
    %%% Slider for frame
    h.Mia_Cor_Frame_Slider = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','slider',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'UserData',[4,i],...
        'Position',[0.1 0.91, 0.08 0.03]);
    h.Mia_Cor_Frame_Listener=addlistener(h.Mia_Cor_Frame_Slider,'Value','PostSet',@Mia_Frame);
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.01 0.87, 0.1 0.03],...
        'String','Frames to use:');
    %%% Editbox for frames to use
    h.Mia_Cor_Frames2Use = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',{@Update_Plots,2,1:3},...
        'Position',[0.12 0.87, 0.03 0.03],...
        'String','0');
    
    %%% RICS Fit table
    h.Mia_Cor_Fit_Table = uitable(...
        'Parent',h.Mia_Cor_Panel,...
        'Units','normalized',...
        'FontSize',8,...
        'BackgroundColor', [Look.Axes;Look.Fore],...
        'ForegroundColor', Look.Disabled,...
        'ColumnName',{'ACF1','CCF','ACF2'},...
        'ColumnWidth',num2cell([40,40,40]),...
        'ColumnEditable',true,...
        'RowName',{'N';'Fix';'D [µm²/s]';'Fix';'w_r [µm]';'Fix';'w_z [µm]';'Fix';'y0';'Fix';'P Size [nm]';'Fix';'P Time [µs]';'Fix';'L Time [ms]';'Fix'},...
        'CellEditCallback',{@Update_Plots,2,1:3},...
        'Position',[0.01 0.46, 0.2 0.4]);
    Data=cell(16,3);
    Data(1,:)={'1'};
    Data(3,:)={'10'};
    Data(5,:)={'0.2'};
    Data(7,:)={'1'};
    Data(9,:)={'0'};
    Data(11,:)={'40'};
    Data(13,:)={'11.11'};
    Data(15,:)={'3.33'};
    Data([2 4],:)={false};
    Data(6:2:16,:)={true};
    h.Mia_Cor_Fit_Table.Data=Data;
    
    %%% Buttons to fit correlation
    h.Mia_Cor_Fit(1) = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','push',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Fit ACF1',...
        'Callback',{@Do_RICS_Fit,1},...
        'Position',[0.01 0.42, 0.06 0.03]);
    h.Mia_Cor_Fit(2) = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','push',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Fit CCF',...
        'Callback',{@Do_RICS_Fit,2},...
        'Position',[0.08 0.42, 0.06 0.03]);
    h.Mia_Cor_Fit(3) = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','push',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String','Fit ACF2',...
        'Callback',{@Do_RICS_Fit,3},...
        'Position',[0.15 0.42, 0.06 0.03]);
    %%% Pupupmenu, to select, what fit to plot
    h.Mia_Cor_Fit_Type = uicontrol(...
        'Parent',h.Mia_Cor_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'String',{'Fit surf','Residuals surf','Fit/Residuals','On Axes plot'},...
        'Callback',{@Update_Plots,2,1:3},...
        'Position',[0.01 0.38, 0.1 0.03]);

    for i=1:3  
        %%% Axes to display correlation images
        h.Mia_Cor_Axes(i,1)= axes(...
            'Parent',h.Mia_Cor_Panel,...
            'Units','normalized',...
            'Position',[0.02+0.25*i 0.67 0.22 0.32]);
        %%% Axes to display correlation surface
        h.Mia_Cor_Axes(i,2)= axes(...
            'Parent',h.Mia_Cor_Panel,...
            'Units','normalized',...
            'Position',[0.02+0.25*i 0.34 0.22 0.32]);
        %%% Axes to display correlation 0 lines
        h.Mia_Cor_Axes(i,4)= axes(...
            'Parent',h.Mia_Cor_Panel,...
            'Units','normalized',...
            'Position',[0.02+0.25*i 0.05 0.22 0.28],...
            'NextPlot','add');
        %%% Axes to display correlation fit surface
        h.Mia_Cor_Axes(i,3)= axes(...
            'Parent',h.Mia_Cor_Panel,...
            'Units','normalized',...
            'Position',[0.02+0.25*i 0.01 0.22 0.32]); 
        linkaxes(h.Mia_Cor_Axes(i,1:3), 'xy');


        %%% Initializes empty plots
        h.Plots.Cor(i,1)=image(zeros(1,1,3),...
            'Parent',h.Mia_Cor_Axes(i,1));
        h.Mia_Cor_Axes(i,1).Color=[0 0 0];
        h.Mia_Cor_Axes(i,1).Visible='off';
        h.Plots.Cor(i,1).Visible='off';
        h.Mia_Cor_Axes(i,1).DataAspectRatio=[1 1 1];
        h.Mia_Cor_Axes(i,1).XTick=[];
        h.Mia_Cor_Axes(i,1).YTick=[];
        h.Plots.Cor(i,2)=surf(zeros(2),zeros(2,2,3),...
            'Parent',h.Mia_Cor_Axes(i,2));
        h.Mia_Cor_Axes(i,2).Visible='off';
        h.Plots.Cor(i,2).Visible='off';
        h.Mia_Cor_Axes(i,2).Color=(Look.Back+0.1)/1.1;
        h.Mia_Cor_Axes(i,2).XColor = Look.Fore;
        h.Mia_Cor_Axes(i,2).YColor = Look.Fore;
        h.Mia_Cor_Axes(i,2).ZColor = Look.Fore;
        h.Mia_Cor_Axes(i,2).XTick=[];
        h.Mia_Cor_Axes(i,2).YTick=[];
        h.Plots.Cor(i,3)=surf(zeros(2),zeros(2,2,3),...
            'Parent',h.Mia_Cor_Axes(i,3));
        h.Mia_Cor_Axes(i,3).Visible='off';
        h.Plots.Cor(i,3).Visible='off';
        h.Mia_Cor_Axes(i,3).XColor = Look.Fore;
        h.Mia_Cor_Axes(i,3).YColor = Look.Fore;
        h.Mia_Cor_Axes(i,3).ZColor = Look.Fore;
        h.Mia_Cor_Axes(i,3).Color=(Look.Back+0.1)/1.1;
        h.Mia_Cor_Axes(i,3).XTick=[];
        h.Mia_Cor_Axes(i,3).YTick=[];
        h.Plots.Cor(i,4)=plot(0,0,...
            'Parent',h.Mia_Cor_Axes(i,4),...
            'Color','b',...
            'LineStyle','none',...
            'Marker','o');
        h.Plots.Cor(i,5)=plot(0,0,...
            'Parent',h.Mia_Cor_Axes(i,4),...
            'Color','b');
        h.Plots.Cor(i,6)=plot(0,0,...
            'Parent',h.Mia_Cor_Axes(i,4),...
            'Color','r',...
            'LineStyle','none',...
            'Marker','o');
        h.Plots.Cor(i,7)=plot(0,0,...
            'Parent',h.Mia_Cor_Axes(i,4),...
            'Color','r');
        h.Mia_Cor_Axes(i,4).Visible='off';
        h.Plots.Cor(i,4).Visible='off';
        h.Plots.Cor(i,5).Visible='off';
        h.Plots.Cor(i,6).Visible='off';
        h.Plots.Cor(i,7).Visible='off';
        h.Mia_Cor_Axes(i,4).XColor = Look.Fore;
        h.Mia_Cor_Axes(i,4).YColor = Look.Fore;
    end
    

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    

    %% N&B Tab
    h.Mia_NB_Tab = uitab(...
        'Parent',h.Mia_Main_Tabs,...
        'Title','N&B',...
        'Units','normalized');   
    h.Mia_NB_Panel = uibuttongroup(...
        'Parent',h.Mia_NB_Tab,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);
       
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.04 0.96, 0.3 0.03],...
        'String','Intensity');
    %%% Axes to display intensity images
    h.Mia_NB_Axes(1)= axes(...
        'Parent',h.Mia_NB_Panel,...
        'Units','normalized',...
        'Position',[0.04 0.55 0.3 0.4]);
    colormap(h.Mia_NB_Axes(1),jet);
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.36 0.96, 0.3 0.03],...
        'String','Number n');
    %%% Axes to display number images
    h.Mia_NB_Axes(2)= axes(...
        'Parent',h.Mia_NB_Panel,...
        'Units','normalized',...
        'Position',[0.36 0.55 0.3 0.4]);
    colormap(h.Mia_NB_Axes(2),jet);
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',14,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.68 0.96, 0.3 0.03],...
        'String','Bightness epsilon');
    %%% Axes to display brightness images
    h.Mia_NB_Axes(3)= axes(...
        'Parent',h.Mia_NB_Panel,...
        'Units','normalized',...
        'Position',[0.68 0.55 0.3 0.4]);
    colormap(h.Mia_NB_Axes(3),jet);    
   
    %%% Popupmenu to select histogram to plot
    h.Mia_NB_1DHist = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.04 0.49, 0.06 0.03],...
        'Callback',{@Update_Plots,3,1:3},...
        'String',{'PCH';'Intensity';'Number';'Brightness'});         
    %%% Axes to display 2D histograms
    h.Mia_NB_Axes(4)= axes(...
        'Parent',h.Mia_NB_Panel,...
        'Units','normalized',...
        'Position',[0.04 0.06 0.26 0.4]);
    
    %%% Popupmenu to select 2D histogram Y axes
    h.Mia_NB_2DHist(1) = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Value',3,...
        'Position',[0.36 0.49, 0.08 0.03],...
        'Callback',{@Update_Plots,3,1:3},...
        'String',{'Intensity';'Number';'Brightness'});
    %%% Popupmenu to select 2D histogram X axes
    h.Mia_NB_2DHist(2) = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Value',1,...
        'Position',[0.45 0.49, 0.08 0.03],...
        'Callback',{@Update_Plots,3,1:3},...
        'String',{'Intensity';'Number';'Brightness'});
    %%% Popupmenu to select 2D histogram Color
    h.Mia_NB_2DHist(3) = uicontrol(...
        'Parent',h.Mia_NB_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', [1 1 1],...
        'ForegroundColor', [0 0 0],...
        'Value',1,...
        'ButtonDownFcn',@NB_2DHist_BG,...
        'Position',[0.54 0.49, 0.05 0.03],...
        'Callback',{@Update_Plots,3,1:3},...
        'String',{'Jet';'Hot';'HSV';'Gray'});
    
    %%% Axes to display various histograms
    h.Mia_NB_Axes(5)= axes(...
        'Parent',h.Mia_NB_Panel,...
        'Units','normalized',...
        'Position',[0.36 0.06 0.3 0.4]);
    colormap(h.Mia_NB_Axes(5),jet);
    
    %%% Initializes empty plots
    h.Plots.NB(1)=imagesc(zeros(1,1),...
        'Parent',h.Mia_NB_Axes(1));
    h.Mia_NB_Axes(1).Color=[0 0 0];
    h.Mia_NB_Axes(1).DataAspectRatio=[1 1 1];
    h.Mia_NB_Axes(1).XTick=[];
    h.Mia_NB_Axes(1).YTick=[];
    a=colorbar(h.Mia_NB_Axes(1));
    a.YColor=Look.Fore;
    h.Plots.NB(2)=imagesc(zeros(1,1),...
        'Parent',h.Mia_NB_Axes(2));
    h.Mia_NB_Axes(2).Color=[0 0 0];
    h.Mia_NB_Axes(2).DataAspectRatio=[1 1 1];
    h.Mia_NB_Axes(2).XTick=[];
    h.Mia_NB_Axes(2).YTick=[];
    a=colorbar(h.Mia_NB_Axes(2));
    a.YColor=Look.Fore;
    h.Plots.NB(3)=imagesc(zeros(1,1),...
        'Parent',h.Mia_NB_Axes(3));
    h.Mia_NB_Axes(3).Color=[0 0 0];
    h.Mia_NB_Axes(3).DataAspectRatio=[1 1 1];
    h.Mia_NB_Axes(3).XTick=[];
    h.Mia_NB_Axes(3).YTick=[];
    a=colorbar(h.Mia_NB_Axes(3));
    a.YColor=Look.Fore;
    h.Plots.NB(5)=imagesc(zeros(1,1,3),...
        'Parent',h.Mia_NB_Axes(5));
    h.Mia_NB_Axes(5).Color=[0 0 0];
    h.Mia_NB_Axes(5).XColor = Look.Fore;
    h.Mia_NB_Axes(5).YColor = Look.Fore;
    h.Mia_NB_Axes(5).XLabel.String='Intensity [kHz]';
    h.Mia_NB_Axes(5).XLabel.Color=Look.Fore;
    h.Mia_NB_Axes(5).YLabel.String='Brightness [kHz]';
    h.Mia_NB_Axes(5).YLabel.Color=Look.Fore;
    h.Mia_NB_Axes(5).YDir='normal';
    
    h.Plots.NB(4)=stairs(0,0,...
        'Parent',h.Mia_NB_Axes(4),...
        'Color','b');
    h.Mia_NB_Axes(4).XColor = Look.Fore;
    h.Mia_NB_Axes(4).YColor = Look.Fore;
    h.Mia_NB_Axes(4).XLabel.String='Counts per pixel';
    h.Mia_NB_Axes(4).XLabel.Color=Look.Fore;
    h.Mia_NB_Axes(4).YLabel.String='Frequency';
    h.Mia_NB_Axes(4).YLabel.Color=Look.Fore;
    %%% Text to show mean
    h.Mia_NB_1DHist_Text = text(....
        'Parent',h.Mia_NB_Axes(4),...
        'Units','normalized',...
        'FontSize',14,...
        'Color', 'b',...
        'Position',[0.7 0.93],...
        'String','');

    %%% Tabs for N%B Settings
    h.Mia_NB_Settings_Tabs = uitabgroup(...
        'Parent',h.Mia_NB_Panel,...
        'Tag','Mia_NB_Settings_Tabs',...
        'Units','normalized',...
        'Position',[0.68 0.01 0.31 0.45]);
        %% Tab for N%B Image and Plot Settings
    h.Mia_NB_Image_Tab = uitab(...
        'Parent',h.Mia_NB_Settings_Tabs,...
        'Title','Image & Plot');        
    h.Mia_NB_Image_Panel = uibuttongroup(...
        'Parent',h.Mia_NB_Image_Tab,...
        'Units','normalized',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'HighlightColor', Look.Control,...
        'ShadowColor', Look.Shadow,...
        'Position',[0 0 1 1]);

    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.92, 0.26 0.06],...
        'String','Frame time [s]:');
    %%% Editbox to set frame time
    h.Mia_NB_Frame = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.29 0.92, 0.14 0.06],...
        'String','1');
    h.FT_Linker=linkprop([h.Mia_NB_Frame,h.Mia_Image_Frame],'String');
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.84, 0.26 0.06],...
        'String','Line time [ms]:');
    %%% Editbox to set line time
    h.Mia_NB_Line = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.29 0.84, 0.14 0.06],...
        'String','3.333');
    h.LT_Linker=linkprop([h.Mia_NB_Line,h.Mia_Image_Line],'String');
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.76, 0.26 0.06],...
        'String','Pixel time [µs]:');
    %%% Editbox to set pixel time
    h.Mia_NB_Pixel = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','edit',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',{@Update_Plots,3,1:3},...
        'Position',[0.29 0.76, 0.14 0.06],...
        'String','11.11');
    h.PT_Linker=linkprop([h.Mia_NB_Pixel,h.Mia_Image_Pixel],'String');
    
    %%% Popupmenu to select N&B channel
    h.Mia_NB_Channel = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','popupmenu',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Control,...
        'ForegroundColor', Look.Fore,...
        'Callback',{@Update_Plots,3,1:3},...
        'Position',[0.55 0.92, 0.25 0.06],...
        'String',{'Channel1','Cross','Channel2'});
    
    %%% Text
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.22 0.66, 0.12 0.06],...
        'String','Min');        
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.36 0.66, 0.12 0.06],...
        'String','Max');
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.5 0.66, 0.12 0.06],...
        'String','Bins');
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.58, 0.18 0.06],...
        'String','Intensity:'); 
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.5, 0.18 0.06],...
        'String','Number:');
    h.Text{end+1} = uicontrol(...
        'Parent',h.Mia_NB_Image_Panel,...
        'Style','text',...
        'Units','normalized',...
        'FontSize',12,...
        'HorizontalAlignment','left',...
        'BackgroundColor', Look.Back,...
        'ForegroundColor', Look.Fore,...
        'Position',[0.02 0.42, 0.18 0.06],...
        'String','Brightness:'); 

    %%% Editboxes for Min, Max and Bin number
    %%% Checkboxes for threshold use
    for i=1:3;
        for j=1:3                
            h.Mia_NB_Hist(i,j) = uicontrol(...
                'Parent',h.Mia_NB_Image_Panel,...
                'Style','edit',...
                'Units','normalized',...
                'FontSize',12,...
                'BackgroundColor', Look.Control,...
                'ForegroundColor', Look.Fore,...
                'Callback',{@Update_Plots,3,1:3},...
                'Position',[0.08+0.14*i 0.66-0.08*j, 0.12 0.06],...
                'String','1');
        end
        h.Mia_NB_UseTH(i) = uicontrol(...
            'Parent',h.Mia_NB_Image_Panel,...
            'Style','checkbox',...
            'Units','normalized',...
            'FontSize',12,...
            'BackgroundColor', Look.Back,...
            'ForegroundColor', Look.Fore,...
            'Value',0,...
            'Callback',{@Update_Plots,3,1:3},...
            'Position',[0.63 0.66-0.08*i, 0.18 0.06],...
            'String','Use TH');
    end
    
    
%% Initializes global variables %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
MIAData=[];
MIAData.Data=[];
MIAData.Cor=cell(3,2);
MIAData.FileName=cell(0);
MIAData.Use=ones(2,1);
MIAData.AR=[];
guidata(h.Mia,h); 
else
     figure(h.Mia); % Gives focus to Pam figure 
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Functions that executes upon closing of mia window %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Close_Mia(Obj,~)
clear global -regexp MIAData
Phasor=findobj('Tag','Phasor');
FCSFit=findobj('Tag','FCSFit');
Pam=findobj('Tag','Pam');
if isempty(Phasor) && isempty(FCSFit) && isempty(Pam)
    clear global -regexp UserValues
end
delete(Obj);



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Functions to load different data types %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_Load(~,~,mode)
global MIAData UserValues
h = guidata(findobj('Tag','Mia'));

switch mode
    case 1 %%% Loads single color TIFFs
        [FileName1,Path1] = uigetfile({'*.tif'}, 'Load TIFFs for channel 1', UserValues.File.MIAPath, 'MultiSelect', 'on');
        
        if all(Path1==0)
            return
        else
            [FileName2,Path2] = uigetfile({'*.tif'}, 'Load TIFFs for channel 1', Path1, 'MultiSelect', 'on');
        end
        UserValues.File.MIAPath = Path1;
        LSUserValues(1);
        %%% Transforms FileName into cell array
        if ~iscell(FileName1)
            FileName1={FileName1};
        end
        if ~iscell(FileName2)
            FileName2={FileName2};
        end
              
        MIAData.Data = [];
        MIAData.Type = mode;
        MIAData.FileName = [];
        %% Clears correlation data and plots
        MIAData.Cor=cell(3,2);
        for i=1:3
            h.Plots.Cor(i,1).CData=zeros(1,1,3);
            h.Plots.Cor(i,2).ZData=zeros(1);
            h.Plots.Cor(i,2).CData=zeros(1,1,3);
            h.Mia_Cor_Axes(i,1).Visible='off';
            h.Mia_Cor_Axes(i,2).Visible='off';
            h.Mia_Cor_Axes(i,3).Visible='off';
            h.Mia_Cor_Axes(i,4).Visible='off';
            h.Plots.Cor(i,1).Visible='off';
            h.Plots.Cor(i,2).Visible='off';
            h.Plots.Cor(i,3).Visible='off';
            h.Plots.Cor(i,4).Visible='off';
            h.Plots.Cor(i,5).Visible='off';
            h.Plots.Cor(i,6).Visible='off';
            h.Plots.Cor(i,7).Visible='off';
        end
        h.Mia_Cor_Frame_Slider.Min=0;
        h.Mia_Cor_Frame_Slider.Max=0;
        h.Mia_Cor_Frame_Slider.SliderStep=[1 1];
        h.Mia_Cor_Frame_Slider.Value=0;
        %% Clears N&B data and plots
        MIAData.NB=[];
        h.Plots.NB(1).CData=zeros(1,1);
        h.Plots.NB(2).CData=zeros(1,1);
        h.Plots.NB(3).CData=zeros(1,1);
        h.Plots.NB(4).YData=0;
        h.Plots.NB(4).XData=0;
        h.Plots.NB(5).CData=zeros(1,1);        
        %% Loads all frames for channel 1
        MIAData.Data{1,1}=single.empty(0,0,0);        
        for i=1:numel(FileName1)  
            MIAData.FileName{1}{i}=FileName1{i};
            FileInfo=imfinfo(fullfile(Path1,FileName1{i}));
            for j=1:numel(FileInfo)
                %%% Updates progress bar
                Progress(((j-1)+numel(FileInfo)*(i-1))/(numel(FileInfo)*numel(FileName1)),...
                    h.Mia_Progress_Axes,...
                    h.Mia_Progress_Text,...
                    ['Loading Frame ' num2str(j) ' of ' num2str(numel(FileInfo)) ' in File ' num2str(i) ' of ' num2str(numel(FileName1)) ' for Channel 1']);                
                MIAData.Data{1,1}(:,:,end+1)=single(imread(fullfile(Path1,FileName1{i}),'TIFF','Index',j));
            end
        end
        %% Updates frame settings for channel 1
        %%% Unlinks framses
        h.Mia_Image_Link.Value = 0;
        h.Mia_Image_Link.Visible = 'off';
        h.Mia_Frame_Slider(1).SliderStep=[1./size(MIAData.Data{1,1},3),10/size(MIAData.Data{1,1},3)];
        h.Mia_Frame_Slider(1).Max=size(MIAData.Data{1,1},3);
        h.Mia_Correlation_Frames.String=['1:' num2str(size(MIAData.Data{1,1},3))];
        h.Mia_Frame_Slider(1).Value=1;  
        h.Mia_Frame_Slider(1).Min=1;
        MIAData.Use=ones(2,size(MIAData.Data{1,1},3));        
        %% Stops function, if only one channel was loaded and clear channel 2
        if all(Path2==0) 
            %%% Clears images
            h.Plots.Image(2,1).CData=zeros(1,1,3);
            h.Mia_Image_Axes(2,1).XLim=[0 1]+0.5;
            h.Mia_Image_Axes(2,1).YLim=[0 1]+0.5;
            h.Plots.Image(2,2).CData=zeros(1,1,3);
            h.Mia_Image_Axes(2,2).XLim=[0 1]+0.5;
            h.Mia_Image_Axes(2,2).YLim=[0 1]+0.5;
            %%% Resets slider
            h.Mia_Frame_Slider(2).SliderStep=[1 1];
            h.Mia_Frame_Slider(2).Max=1;
            h.Mia_Frame_Slider(2).Value=1;
            h.Mia_Frame_Slider(2).Min=1;
            h.Mia_Frame(2).String='1';
            Progress(1);
            %%% Updates plot
            Mia_ROI([],[],1)  
            return
        end
        %% Loads all frames for channel 2
        MIAData.Data{2,1}=single.empty(0,0,0);
        for i=1:numel(FileName2)
            MIAData.FileName{2}{i}=FileName2{i};
            FileInfo=imfinfo(fullfile(Path2,FileName2{i}));
            for j=1:numel(FileInfo)
                %%% Updates progress bar
                Progress(((j-1)+numel(FileInfo)*(i-1))/(numel(FileInfo)*numel(FileName2)),...
                    h.Mia_Progress_Axes,...
                    h.Mia_Progress_Text,...
                    ['Loading Frame ' num2str(j) ' of ' num2str(numel(FileInfo)) ' in File ' num2str(i) ' of ' num2str(numel(FileName2)) ' for Channel 2']);
                MIAData.Data{2,1}(:,:,end+1)=single(imread(fullfile(Path2,FileName2{i}),'TIFF','Index',j));
            end
        end
        %%% Updates frame settings for channel 2
        h.Mia_Frame_Slider(2).SliderStep=[1./size(MIAData.Data{2,1},3),10/size(MIAData.Data{2,1},3)];
        h.Mia_Frame_Slider(2).Max=size(MIAData.Data{2,1},3);
        h.Mia_Frame_Slider(2).Value=1;
        h.Mia_Frame_Slider(2).Min=1;
        h.Plots.ROI(2).Position=[10 10 200 200];
        
        %%% Links frames
        h.Mia_Image_Link.Value = 1;
        h.Mia_Image_Link.Visible = 'on';
        Progress(1);  
        %%% Updates plots
        Mia_ROI([],[],1)
        
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Updates mia plots %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Update_Plots(~,~,mode,channel)
h = guidata(findobj('Tag','Mia'));
global MIAData UserValues

h.Mia_Progress_Text.String = 'Updating plots';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;
%% Plots intensity images
if any(mode==1)    
    for i=channel
        %% Selects colormap
        switch h.Mia_Image_Colormap(i).Value
            case 1
                Colormap = [1 0 0; gray(64)];
                h.Mia_Image_Colormap(i).BackgroundColor = UserValues.Look.Control;
            case 2
                Colormap = [0 0 0; jet(64)];
                h.Mia_Image_Colormap(i).BackgroundColor = UserValues.Look.Control;
            case 3
                Colormap = [0 1 0; hot(64)];
                h.Mia_Image_Colormap(i).BackgroundColor = UserValues.Look.Control;
            case 4
                Colormap=[0 0 0; hsv(64)];
                h.Mia_Image_Colormap(i).BackgroundColor = UserValues.Look.Control;
            case 5
                Colormap = gray(64).*repmat(h.Mia_Image_Colormap(i).UserData,[64,1]);
                Colormap = [circshift(Colormap(end,:),[0 2]); Colormap];
                h.Mia_Image_Colormap(i).BackgroundColor = h.Mia_Image_Colormap(i).UserData;
        end
        
        %% Plots main image
        if size(MIAData.Data,1)>=1
            if size(MIAData.Data,1)>=i
                Frame=round(h.Mia_Frame_Slider(i).Value);
                Image=double(MIAData.Data{i,1}(:,:,Frame));
                Image=round(63*(Image-min(min(Image)))/(max(max(Image))-min(min(Image))))+2;
                Image=reshape(Colormap(Image,:),[size(Image,1),size(Image,2),3]);
                h.Plots.Image(i,1).CData=Image;
                h.Mia_Image_Axes(i,1).XLim=[0 size(Image,2)]+0.5;
                h.Mia_Image_Axes(i,1).YLim=[0 size(Image,1)]+0.5;
            end
            drawnow;
        end
        
        %% Plots second image
        if size(MIAData.Data,2)>=2
            if size(MIAData.Data,1)>=i
                Frame=round(h.Mia_Frame_Slider(i).Value);
                From=h.Plots.ROI(i).Position(1:2)+0.5;
                To=From+h.Plots.ROI(i).Position(3:4)-1;
                switch h.Mia_Second(i).Value
                    case 1 %%% Uses ROI of original image
                        Image=double(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),Frame));
                    case 2 %%% Uses ROI of corrected image (=> dynamic species)
                        Image=double(MIAData.Data{i,2}(:,:,Frame));
                    case 3 %%% Uses ROI of correctiond image (=> static species)
                        Image=double(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),Frame)-MIAData.Data{i,2}(:,:,Frame));
                end
                Image=round(63*(Image-min(min(Image)))/(max(max(Image))-min(min(Image))))+2;
                Image(isnan(Image))=2;
                Image(~MIAData.AR{i}(:,:,Frame))=1;
                Image = reshape(Colormap(Image,:),[size(Image,1),size(Image,2),3]);
                h.Plots.Image(i,2).CData=Image;
                h.Mia_Image_Axes(i,2).XLim=[0 size(Image,2)]+0.5;
                h.Mia_Image_Axes(i,2).YLim=[0 size(Image,1)]+0.5;
            end
            drawnow;
        end
    end
end

%% Plots correlations
if any(mode==2)
    %%% Selects colormap
    switch h.Cor_Colormap.Value
        case 1
            Colormap=gray(64);
            h.Cor_Colormap.BackgroundColor=UserValues.Look.Control;
        case 2
            Colormap=jet(64);
            h.Cor_Colormap.BackgroundColor=UserValues.Look.Control;
        case 3
            Colormap=hot(64);
            h.Cor_Colormap.BackgroundColor=UserValues.Look.Control;
        case 4
            Colormap=hsv(64);
            h.Cor_Colormap.BackgroundColor=UserValues.Look.Control;
        case 5
            Colormap=gray(64).*repmat(h.Cor_Colormap.UserData,[64,1]);
            h.Cor_Colormap.BackgroundColor=h.Cor_Colormap.UserData;
    end
    %%% Determins frame to plot            
    Frame=round(h.Mia_Cor_Frame_Slider.Value); 
    %%% Determins correlation size to plot
    Size=str2double(h.Mia_Cor_Size.String);    
    %%% Updates correlationplots 
    for i=channel
        if ~isempty(MIAData.Cor{i,1})
            %%% Forces Size into bounds
            if Size>size(MIAData.Cor{i},1) || Size>size(MIAData.Cor{i},2)
                Size=min([size(MIAData.Cor{i},1),size(MIAData.Cor{i},2)]);
                h.Mia_Cor_Size.String=num2str(Size);
            end
            %%% Determines center of correlation
            X(1)=ceil(floor(size(MIAData.Cor{i,1},1)/2)-Size/2)+1;
            X(2)=ceil(floor(size(MIAData.Cor{i,1},1)/2)+Size/2);
            Y(1)=ceil(floor(size(MIAData.Cor{i,1},2)/2)-Size/2)+1;
            Y(2)=ceil(floor(size(MIAData.Cor{i,1},2)/2)+Size/2);
            %%% Plots average correlation, if frame 0 was selected
            if Frame==0
                Frames=str2num(h.Mia_Cor_Frames2Use.String); %#ok<ST2NM>
                Frames=Frames((Frames>0) & (Frames < size(MIAData.Cor{i,1},3)));
                Image=mean(MIAData.Cor{i,1}(X(1):X(2),Y(1):Y(2),Frames),3);
            else
                Image=MIAData.Cor{i,1}(X(1):X(2),Y(1):Y(2),Frame);  
            end
            %%% Plots surface plot of correlation
            h.Plots.Cor(i,2).ZData=Image;
            %%% Resizes correlation and plots it as RGB
            Image=round(63*(Image-min(min(Image)))/(max(max(Image))-min(min(Image))))+1;
            Image(isnan(Image))=1;
            Image=reshape(Colormap(Image,:),[size(Image,1),size(Image,2),3]);
            h.Plots.Cor(i,1).CData=Image;
            h.Mia_Cor_Axes(i,1).XLim=[0 size(Image,2)]+0.5;
            h.Mia_Cor_Axes(i,1).YLim=[0 size(Image,1)]+0.5;
            
            %%% Calculate average of verteces surrounding the face in surf plot
            Image_Surf=h.Plots.Cor(i,2).ZData;
            Image_Surf=Image_Surf...
                +circshift(Image_Surf,[-1  0 0])...
                +circshift(Image_Surf,[-1 -1 0])...
                +circshift(Image_Surf,[ 0 -1 0]);
            %%% Resizes face intenity and plots it as RGB
            Image_Surf=round(63*(Image_Surf-min(min(Image_Surf)))/(max(max(Image_Surf))-min(min(Image_Surf))))+1;
            Image_Surf(isnan(Image_Surf))=1;
            Image_Surf=reshape(Colormap(Image_Surf,:),[size(Image_Surf,1),size(Image_Surf,2),3]);
            h.Plots.Cor(i,2).CData=Image_Surf;
                      
            %%% Calculates fit from table values
            Fit=reshape(Calc_RICS_Fit(i),[Size,Size]);             
            %%% Changes fit axes visibility
            h.Mia_Cor_Axes(i,3).Visible='on';
            h.Plots.Cor(i,3).Visible='on';
            h.Mia_Cor_Axes(i,4).Visible='off';
            h.Plots.Cor(i,4).Visible='off';
            h.Plots.Cor(i,5).Visible='off';
            h.Plots.Cor(i,6).Visible='off';
            h.Plots.Cor(i,7).Visible='off';
            %%% Determins fit plot type
            switch h.Mia_Cor_Fit_Type.Value
                case 1 %%% Plots fit surf plot
                    %%% Calculate average of verteces surrounding the face in fit surf plot
                    Fit_Faces=(Fit+circshift(Fit,[-1 0 0])+circshift(Fit,[-1 -1 0])+circshift(Fit,[0 -1 0]))/4;
                    %%% Resizes fit face intenity and applies colormap
                    Fit_Faces=round(63*(Fit_Faces-min(min(Fit_Faces)))/(max(max(Fit_Faces))-min(min(Fit_Faces))))+1;
                    Fit_Faces=reshape(Colormap(Fit_Faces,:),[size(Fit_Faces,1),size(Fit_Faces,2),3]);
                    %%% Links fit z-axes to data axes
                    h.Mia_Cor_Axes(i,3).ZLim=h.Mia_Cor_Axes(i,2).ZLim;
                case 2 %%% Plots fit residual surf plot
                    %%% Calculates standard error of mean or uses one
                    if Frame==0
                        SEM=std(MIAData.Cor{i,1}(X(1):X(2),Y(1):Y(2),Frames),0,3)/sqrt(numel(Frames));
                    else
                        SEM=ones(size(Fit,1),size(Fit,2));
                    end 
                    
                    
                    %%% Calculates weighted residuals
                    Fit=(h.Plots.Cor(i,2).ZData-Fit)./SEM;
                    %%% Calculate average of verteces surrounding the face in residual surf plot
                    Fit_Faces=(Fit+circshift(Fit,[-1 0 0])+circshift(Fit,[-1 -1 0])+circshift(Fit,[0 -1 0]))/4;
                    %%% Resizes residual face intenity and applies colormap
                    Fit_Faces=round(63*(Fit_Faces-min(min(Fit_Faces)))/(max(max(Fit_Faces))-min(min(Fit_Faces))))+1;

                    Fit_Faces=reshape(Colormap(Fit_Faces,:),[size(Fit_Faces,1),size(Fit_Faces,2),3]);
                    %%% Autosets z axes
                    h.Mia_Cor_Axes(i,3).ZLimMode='auto';
                case 3 %%% Plots fit surf plot with residuals as blue (neg), red(pos) and gray(neutal)
                    %%% Calculates standard error of mean or uses one
                    if Frame==0
                        SEM=std(MIAData.Cor{i,1}(X(1):X(2),Y(1):Y(2),Frames),0,3)/sqrt(numel(Frames));
                    else
                        SEM=ones(size(Fit,1),size(Fit,2));
                    end 
                    if any(any(SEM==0));
                        SEM=1;
                    end
                    %%% Calculates weighted residuals
                    Residuals=(h.Plots.Cor(i,2).ZData-Fit)./SEM;
                    %%% Calculate average of verteces surrounding the face in fit/residual surf plot
                    Residuals=(Residuals+circshift(Residuals,[-1 0 0])+circshift(Residuals,[-1 -1 0])+circshift(Residuals,[0 -1 0]))/4;
                    %%% Generates colormap blue-gray-red
                    Errormap=zeros(64,3);
                    Errormap(:,1)=[linspace(0,0.8,32), repmat(0.8,[1,32])]; 
                    Errormap(:,2)=[linspace(0,0.8,32), linspace(0.8,0,32)]; 
                    Errormap(:,3)=[repmat(0.8,[1,32]), linspace(0.8,0,32)];
                    %%% Applies colormap to residuals from -3 to +3
                    Residuals=round((Residuals+3)/6*64);
                    Residuals(Residuals<1)=1;
                    Residuals(Residuals>64)=64;
                    Fit_Faces=reshape(Errormap(Residuals(:),:),[size(Fit,1),size(Fit,2),3]);
                    %%% Links fit z-axes to data axes
                    h.Mia_Cor_Axes(i,3).ZLim=h.Mia_Cor_Axes(i,2).ZLim;
                case 4 %%% Plots x and y axes of the fit and the data
                    h.Mia_Cor_Axes(i,3).Visible='off';
                    h.Plots.Cor(i,3).Visible='off';                    
                    h.Mia_Cor_Axes(i,4).Visible='on';
                    h.Plots.Cor(i,4).XData=(1:size(Fit,2))-round(size(Fit,2)/2);
                    h.Plots.Cor(i,4).YData=h.Plots.Cor(i,2).ZData(round(size(Fit,2)/2),:);
                    h.Plots.Cor(i,4).Visible='on';
                    h.Plots.Cor(i,5).XData=(1:size(Fit,2))-round(size(Fit,2)/2);
                    h.Plots.Cor(i,5).YData=Fit(round(size(Fit,2)/2),:);
                    h.Plots.Cor(i,5).Visible='on';
                    h.Plots.Cor(i,6).XData=(1:size(Fit,1))-round(size(Fit,1)/2);
                    h.Plots.Cor(i,6).YData=h.Plots.Cor(i,2).ZData(:,round(size(Fit,1)/2));
                    h.Plots.Cor(i,6).Visible='on';
                    h.Plots.Cor(i,7).XData=(1:size(Fit,1))-round(size(Fit,1)/2);
                    h.Plots.Cor(i,7).YData=Fit(:,round(size(Fit,1)/2));
                    h.Plots.Cor(i,7).Visible='on';
                    
                    Fit_Faces=Fit;
            end
            %%% Plots fit and applies face color
            h.Plots.Cor(i,3).ZData=Fit;
            h.Plots.Cor(i,3).CData=Fit_Faces;            
        end        
    end

end

%% Plots N&B data
if any(mode==3) && isfield(MIAData.NB,'PCH')
    %%% Selects channel to plot
    i=h.Mia_NB_Channel.Value;
    %%% Selects nonempty channel
    if size(MIAData.NB.PCH,2)<i || isempty(MIAData.NB.PCH{i})
        k=1;
        while isempty(MIAData.NB.PCH{k}); k=k+1;end
        i=k;
        h.Mia_NB_Channel.Value=i;
    end
    %% Updates intensity, number and brightness plots
    %%% Images intensity in kHz in borders determined by threshold
    h.Plots.NB(1).CData=MIAData.NB.Int{i}/str2double(h.Mia_NB_Pixel.String)*10^3;
    h.Mia_NB_Axes(1).CLim=[str2double(h.Mia_NB_Hist(1,1).String),str2double(h.Mia_NB_Hist(2,1).String)];
    h.Mia_NB_Axes(1).XLim=[0 size(MIAData.NB.Int{i},2)]+0.5;
    h.Mia_NB_Axes(1).YLim=[0 size(MIAData.NB.Int{i},1)]+0.5;    
    %%% Images number in borders determined by threshold
    h.Plots.NB(2).CData=MIAData.NB.Num{i};
    h.Mia_NB_Axes(2).CLim=[str2double(h.Mia_NB_Hist(1,2).String),str2double(h.Mia_NB_Hist(2,2).String)];
    h.Mia_NB_Axes(2).XLim=[0 size(MIAData.NB.Int{i},2)]+0.5;
    h.Mia_NB_Axes(2).YLim=[0 size(MIAData.NB.Int{i},1)]+0.5;
    %%% Images brightness in kHz in borders determined by threshold
    h.Plots.NB(3).CData=MIAData.NB.Eps{i}/str2double(h.Mia_NB_Pixel.String)*10^3;
    h.Mia_NB_Axes(3).CLim=[str2double(h.Mia_NB_Hist(1,3).String),str2double(h.Mia_NB_Hist(2,3).String)];
    h.Mia_NB_Axes(3).XLim=[0 size(MIAData.NB.Int{i},2)]+0.5;
    h.Mia_NB_Axes(3).YLim=[0 size(MIAData.NB.Int{i},1)]+0.5;

    %% Plots 1D histogram of selected parameter
    %%% Removes pixel determined by thresholds
    Use=((MIAData.NB.Int{i}/str2double(h.Mia_NB_Pixel.String)*10^3>=str2double(h.Mia_NB_Hist(1,1).String) &... %%% Lower int TH
        MIAData.NB.Int{i}/str2double(h.Mia_NB_Pixel.String)*10^3<=str2double(h.Mia_NB_Hist(2,1).String)) |... %%% Upper in TH
        repmat(~h.Mia_NB_UseTH(1).Value,size(MIAData.NB.Int{i}))) &... %%% Do not apply if checked
        ((MIAData.NB.Num{i}>=str2double(h.Mia_NB_Hist(1,2).String) &... %%% Lower number TH
        MIAData.NB.Num{i}<=str2double(h.Mia_NB_Hist(2,2).String)) |... %%% Upper number TH
        repmat(~h.Mia_NB_UseTH(2).Value,size(MIAData.NB.Int{i}))) &...%%% Do not apply if checked
        ((MIAData.NB.Eps{i}/str2double(h.Mia_NB_Pixel.String)*10^3>=str2double(h.Mia_NB_Hist(1,3).String) &... %%% Lower brightness TH
        MIAData.NB.Eps{i}/str2double(h.Mia_NB_Pixel.String)*10^3<=str2double(h.Mia_NB_Hist(2,3).String)) |... %%% Upper brightness TH
        repmat(~h.Mia_NB_UseTH(3).Value,size(MIAData.NB.Int{i}))); %%% Do not apply if checked
    %%% Plots bar histogram
    switch h.Mia_NB_1DHist.Value
        case 1 %%% PCH histogram; Not threshold
            h.Plots.NB(4).YData=MIAData.NB.PCH{i};
            h.Plots.NB(4).XData=0:(numel(MIAData.NB.PCH{i})-1);
            h.Mia_NB_Axes(4).XLabel.String='Counts per pixel';
            h.Mia_NB_1DHist_Text.String='';
        case 2 %%% Intensity histogram
            h.Plots.NB(4).XData=linspace(str2double(h.Mia_NB_Hist(1,1).String),str2double(h.Mia_NB_Hist(2,1).String),str2double(h.Mia_NB_Hist(3,1).String));
            h.Plots.NB(4).YData=histc(MIAData.NB.Int{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3,h.Plots.NB(4).XData);
            h.Mia_NB_Axes(4).XLabel.String='Intensity [kHz]';
            h.Mia_NB_1DHist_Text.String=[num2str(mean(MIAData.NB.Int{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3),'%6.3f') '±' num2str(std(MIAData.NB.Int{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3),'%6.3f') ' kHz'];
        case 3 %%% Number histogram
            h.Plots.NB(4).XData=linspace(str2double(h.Mia_NB_Hist(1,2).String),str2double(h.Mia_NB_Hist(2,2).String),str2double(h.Mia_NB_Hist(3,2).String));
            h.Plots.NB(4).YData=histc(MIAData.NB.Num{i}(Use),h.Plots.NB(4).XData);
            h.Mia_NB_Axes(4).XLabel.String='Number';
            h.Mia_NB_1DHist_Text.String=[num2str(mean(MIAData.NB.Num{i}(Use)),'%6.3f') '±' num2str(std(MIAData.NB.Num{i}(Use)),'%6.3f')];
        case 4 %%% Brightness histogram
            h.Plots.NB(4).XData=linspace(str2double(h.Mia_NB_Hist(1,3).String),str2double(h.Mia_NB_Hist(2,3).String),str2double(h.Mia_NB_Hist(3,3).String));
            h.Plots.NB(4).YData=histc(MIAData.NB.Eps{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3,h.Plots.NB(4).XData);
            h.Mia_NB_Axes(4).XLabel.String='Brightness [kHz]';
            h.Mia_NB_1DHist_Text.String=[num2str(mean(MIAData.NB.Eps{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3),'%6.3f') '±' num2str(std(MIAData.NB.Eps{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3),'%6.3f') ' kHz'];
    end
    h.Mia_NB_1DHist_Text.Position(1)=0.99-h.Mia_NB_1DHist_Text.Extent(3);
    %%% Set X-Limit; uses 1/2 of binsize to not cut first and last bar
    h.Mia_NB_Axes(4).XLim=[h.Plots.NB(4).XData(1)-diff(h.Plots.NB(4).XData(1:2)/2),...
                           h.Plots.NB(4).XData(end)+diff(h.Plots.NB(4).XData(1:2))/2];
                                              
    %% Plots 2D histogram of selected parameters
    %%% Selects Colormap
    switch h.Mia_NB_2DHist(3).Value
        case 1
            Color=jet(64);
        case 2
            Color=hot(64);
        case 3
            Color=hsv(64);
        case 4
            Color=gray(64);
    end
    Color=[h.Mia_NB_2DHist(3).BackgroundColor; Color];
    h.Mia_NB_Axes(5).XColor = h.Mia_NB_2DHist(3).ForegroundColor;
    h.Mia_NB_Axes(5).YColor = h.Mia_NB_2DHist(3).ForegroundColor;
   
    %%% Selects x axis bounds and bins
    MinX=str2double(h.Mia_NB_Hist(1,h.Mia_NB_2DHist(2).Value).String);
    MaxX=str2double(h.Mia_NB_Hist(2,h.Mia_NB_2DHist(2).Value).String);
    BinX=str2double(h.Mia_NB_Hist(3,h.Mia_NB_2DHist(2).Value).String);
    %%% Determins parameter for x axis
    switch h.Mia_NB_2DHist(2).Value
        case 1
            X=MIAData.NB.Int{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3;
            h.Mia_NB_Axes(5).XLabel.String='Intensity [kHz]';
        case 2
            X=MIAData.NB.Num{i}(Use);
            h.Mia_NB_Axes(5).XLabel.String='Number';
        case 3
            X=MIAData.NB.Eps{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3;
            h.Mia_NB_Axes(5).XLabel.String='Brightness [kHz]';
    end
    %%% Scales x data into bins
    X=floor(BinX*(X-MinX)/(MaxX-MinX));
    
    %%% Selects y axis bounds and bins
    MinY=str2double(h.Mia_NB_Hist(1,h.Mia_NB_2DHist(1).Value).String);
    MaxY=str2double(h.Mia_NB_Hist(2,h.Mia_NB_2DHist(1).Value).String);
    BinY=str2double(h.Mia_NB_Hist(3,h.Mia_NB_2DHist(1).Value).String);
    %%% Determins parameter for y axis
    switch h.Mia_NB_2DHist(1).Value
        case 1
            Y=MIAData.NB.Int{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3;
            h.Mia_NB_Axes(5).YLabel.String='Intensity [kHz]';
        case 2
            Y=MIAData.NB.Num{i}(Use);
            h.Mia_NB_Axes(5).YLabel.String='Number';
        case 3
            Y=MIAData.NB.Eps{i}(Use)/str2double(h.Mia_NB_Pixel.String)*10^3;
            h.Mia_NB_Axes(5).YLabel.String='Brightness [kHz]';
    end
    %%% Scales y data into bins
    Y=floor(BinY*(Y-MinY)/(MaxY-MinY));
    
    %%% Removes pixels with Y<0, due to the way the histogram is calculated
    X=X(Y>0); Y=Y(Y>0);X=X(Y<BinY); Y=Y(Y<BinY);
    Y=Y(X>0); X=X(X>0);Y=Y(X<BinX); X=X(X<BinX);
    %%% Calculates 2D histogram
    if ~isempty(X)
        Image=reshape(histc(Y+(BinY*(X-1)),1:(BinX*BinY)),[BinY,BinX]);
        Image=ceil(64*Image/max(Image(:)))+1;
        Image=reshape(Color(Image,:),[BinY, BinX, 3]);
        %%% Plots and scales 2D histogram
        h.Plots.NB(5).CData=Image;
        h.Plots.NB(5).XData=linspace(MinX,MaxX,BinX);
        h.Plots.NB(5).YData=linspace(MinY,MaxY,BinY);
        h.Mia_NB_Axes(5).XLim=[MinX MaxX]-(MaxX-MinX)/(2*BinX);
        h.Mia_NB_Axes(5).YLim=[MinY MaxY]-(MaxY-MinY)/(2*BinY);        
    end
end
if numel(MIAData.FileName)==2
    h.Mia_Progress_Text.String = [MIAData.FileName{1}{1} ' / ' MIAData.FileName{2}{1}];
elseif numel(MIAData.FileName)==1
    h.Mia_Progress_Text.String = MIAData.FileName{1}{1};  
else
    h.Mia_Progress_Text.String = 'Nothing loaded';
end
h.Mia_Progress_Axes.Color=UserValues.Look.Control;




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Moves through frames %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_Frame(~,e,mode,channel)
global MIAData
h = guidata(findobj('Tag','Mia'));

if size(MIAData.Data,1)>0
    %%% Determins slider in case of listener callback
    if nargin<4
        mode=e.AffectedObject.UserData(1);
        channel=e.AffectedObject.UserData(2);
    end
    %%% Updates UIs
    switch mode
        case 1 %%% Image frames editbox changed
            Frame=str2double(h.Mia_Frame(channel).String);
            %%% Forces frame into bounds
            if Frame>size(MIAData.Data{channel,1},3)
                Frame=size(MIAData.Data{channel,1},3);
                h.Mia_Frame(channel).String=num2str(size(MIAData.Data{channel,1},3));
            end
            if mod(Frame,1)~=0
                Frame=round(Frame);
                h.Mia_Frame(channel).String=num2str(Frame);
            end
            if Frame<1;
                Frame=1;
                h.Mia_Frame(channel).String='1';
            end
            h.Mia_Frame_Slider(channel).Value=Frame;
        case 2 %%% Image frames slider changed
            Frame=h.Mia_Frame_Slider(channel).Value;

            if mod(Frame,1)~=0
                Frame=round(Frame);                
                h.Mia_Frame_Slider(channel).Value=Frame;             
            end
            if Frame<1
                Frame=1;
            end
            h.Mia_Frame(channel).String=num2str(Frame);
            
            if h.Mia_Image_Link.Value
                h.Mia_Frame(mod(2*channel,3)).String=num2str(Frame);
                h.Mia_Frame_Slider(mod(2*channel,3)).Value=Frame;
                Update_Plots([],[],1,[1 2]);
            else
                Update_Plots([],[],1,channel);
            end
        case 3 %%% Cor frames editbox changed
            Frame=str2double(h.Mia_Cor_Frame.String);
            i=find(~cellfun(@isempty,MIAData.Cor),1,'first');
            %%% Forces frame into bounds
            if Frame>size(MIAData.Cor{i},3)
                Frame=size(MIAData.Cor{i},3);
                h.Mia_Cor_Frame.String=num2str(size(MIAData.Cor{i},3));
            end
            if mod(Frame,1)~=0
                Frame=round(Frame);
                h.Mia_Cor_Frame.String=num2str(Frame);
            end
            if Frame<0;
                Frame=0;
                h.Mia_Cor_Frame.String='1';
            end
            h.Mia_Cor_Frame_Slider.Value=Frame;
        case 4 %%% Cor frames slider changed
            Frame=h.Mia_Cor_Frame_Slider.Value;
            if mod(Frame,1)~=0
                Frame=round(Frame);
                h.Mia_Cor_Frame_Slider.Value=Frame;
            end
            if Frame<0;
                Frame=0;
                h.Mia_Cor_Frame.String='1';
            end
            h.Mia_Cor_Frame.String=num2str(Frame);
            Update_Plots([],[],2,1:3);
    end
    %%% Sets the frame use value
    h.Mia_FrameUse(1).Value=MIAData.Use(1,str2double(h.Mia_Frame(1).String));
    h.Mia_FrameUse(2).Value=MIAData.Use(2,str2double(h.Mia_Frame(2).String));
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Changes custom plots color %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_Color(Obj,~,mode)
Color=uisetcolor;
if numel(Color)
    Obj.UserData=Color;
end
Update_Plots([],[],1,mode);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Selects\Unselects frames %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_UseFrame(~,~,mode)
global MIAData
h = guidata(findobj('Tag','Mia'));
if h.Mia_Image_Link.Value
    MIAData.Use(1,str2double(h.Mia_Frame(mode).String))=h.Mia_FrameUse(mode).Value;
    MIAData.Use(2,str2double(h.Mia_Frame(mode).String))=h.Mia_FrameUse(mode).Value;
    h.Mia_FrameUse(mod(mode,2)+1).Value=h.Mia_FrameUse(mode).Value;
else
    MIAData.Use(mode,str2double(h.Mia_Frame(mode).String))=h.Mia_FrameUse(mode).Value;
end
h.Mia_Correlation_FramesUse.Value=2;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Generates corrected images %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_Correct(~,~)
global MIAData
h = guidata(findobj('Tag','Mia'));
h.Mia_Progress_Text.String = 'Applying Correction';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;

%%% Extracts ROI position
From=h.Plots.ROI(1).Position(1:2)+0.5;
To=From+h.Plots.ROI(1).Position(3:4)-1;

h.Mia_Subtract_Pixel.Visible='off';
h.Mia_Subtract_Pixel_Text.Visible='off';
h.Mia_Subtract_Frames.Visible='off';
h.Mia_Subtract_Frames_Text.Visible='off';
h.Mia_Add_Pixel.Visible='off';
h.Mia_Add_Pixel_Text.Visible='off';
h.Mia_Add_Frames.Visible='off';
h.Mia_Add_Frames_Text.Visible='off';

MIAData.AR=[];
for i=1:2
    if size(MIAData.Data,1)>=i  
        MIAData.Data{i,2}=[];
        %% Adds to image
        switch h.Mia_Add.Value
            case 1 %%% Do nothing
                MIAData.Data{i,2}=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:);
            case 2 %%% Total ROI mean
                MIAData.Data{i,2}=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:)...
                                 +(mean2(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:)));
            case 3 %%% Frame ROI mean
                MIAData.Data{i,2}=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:)...
                                 +(repmat(mean(mean((MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:)))),[(To(2)-From(2)+1),(To(1)-From(1)+1),1]));
            case 4 %%% Pixel mean
                MIAData.Data{i,2}=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:)...
                                 +(repmat(mean(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:),3),[1,1,size(MIAData.Data{i,1},3)]));
            case 5 %%% Moving average
                h.Mia_Add_Pixel.Visible='on';
                h.Mia_Add_Pixel_Text.Visible='on';
                h.Mia_Add_Frames.Visible='on';
                h.Mia_Add_Frames_Text.Visible='on';                
                Box=[str2double(h.Mia_Add_Pixel.String), str2double(h.Mia_Add_Pixel.String), str2double(h.Mia_Add_Frames.String)];
                
                MIAData.Data{i,2}=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:);                 
                %%% Forces averaging sizes into bounds
                if any(Box<1) || any(Box>size(MIAData.Data{i,2}))
                    Box(Box<1)=1;
                    if Box(1)>size(MIAData.Data{i,2},1)
                        Box(1)=size(MIAData.Data{i,2},1);
                    end
                    if Box(2)>size(MIAData.Data{i,2},2)
                        Box(2)=size(MIAData.Data{i,2},2);
                    end
                    if Box(3)>size(MIAData.Data{i,2},3)
                        Box(3)=min(size(MIAData.Data{i,2},3));   
                    end 
                    h.Mia_Add_Pixel.String=num2str(Box(1));
                    h.Mia_Add_Frames.String=num2str(Box(3));
                end
                %%% Calculates Filter
                Filter=ones(Box)/prod(Box);
                MIAData.Data{i,2}=MIAData.Data{i,2}+imfilter(MIAData.Data{i,2},Filter,'replicate');
        end
        %% Subtracts from image
        switch h.Mia_Subtract.Value
            case 1 %%% Do nothing
            case 2 %%% Frame ROI mean
                MIAData.Data{i,2}=MIAData.Data{i,2}...
                                 -(repmat(mean(mean(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:))),[(To(2)-From(2)+1),(To(1)-From(1)+1),1]));
            case 3 %%% Pixel mean
                MIAData.Data{i,2}=MIAData.Data{i,2}...
                                 -(repmat(mean(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:),3),[1,1,size(MIAData.Data{i,1},3)]));
            case 4 %%% Moving average
                h.Mia_Subtract_Pixel.Visible='on';
                h.Mia_Subtract_Pixel_Text.Visible='on';
                h.Mia_Subtract_Frames.Visible='on';
                h.Mia_Subtract_Frames_Text.Visible='on';
                Box=[str2double(h.Mia_Subtract_Pixel.String), str2double(h.Mia_Subtract_Pixel.String), str2double(h.Mia_Subtract_Frames.String)];
                 
                %%% Forces averaging sizes into bounds
                if any(Box<1) || any(Box>size(MIAData.Data{i,2}))
                    Box(Box<1)=1;
                    if Box(1)>size(MIAData.Data{i,2},1)
                        Box(1)=size(MIAData.Data{i,2},1);
                    end
                    if Box(2)>size(MIAData.Data{i,2},2)
                        Box(2)=size(MIAData.Data{i,2},2);
                    end
                    if Box(3)>size(MIAData.Data{i,2},3)
                        Box(3)=min(size(MIAData.Data{i,2},3));   
                    end 
                    h.Mia_Subtract_Pixel.String=num2str(Box(1));
                    h.Mia_Subtract_Frames.String=num2str(Box(3));
                end 
                %%% Calculates Filter
                Filter=ones(Box)/prod(Box);
                MIAData.Data{i,2}=MIAData.Data{i,2}-imfilter(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),:),Filter,'replicate');    
        end
        
        MIAData.AR{i}=true(size(MIAData.Data{i,2}));
    end
    
end
Update_Plots([],[],1,1:size(MIAData.Data,1))
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Funtion to update ROI position and size %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Mia_ROI(~,e,mode)
global MIAData
h = guidata(findobj('Tag','Mia'));

h.Mia_Progress_Text.String = 'Calculating ROI';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;

if ~isempty(MIAData.Data)
    switch mode
        case 1 %%% Editboxes were changed
            %%% Update Size
            Size=round([str2double(h.Mia_ROI_SizeX.String) str2double(h.Mia_ROI_SizeY.String)]);
            %%% Forces ROI size into bounds
            if Size(1)>size(MIAData.Data{1,1},1) || Size(1)<1
                Size(1)=size(MIAData.Data{1,1},1);
                h.Mia_ROI_SizeX.String=num2str(Size(1));
            end
            if Size(2)>size(MIAData.Data{1,1},2) || Size(2)<1
                Size(2)=size(MIAData.Data{1,1},2);
                h.Mia_ROI_SizeY.String=num2str(Size(2));
            end
            %%% Update Position
            Pos=round([str2double(h.Mia_ROI_PosX.String) str2double(h.Mia_ROI_PosY.String)]);
            %%% Forces ROI size into bounds
            Pos(Pos<1)=1;
            if (Pos(1)+Size(1)-1)>size(MIAData.Data{1,1},1)
                Pos(1)=(size(MIAData.Data{1,1},1)-Size(1)+1);
                h.Mia_ROI_PosX.String=num2str(Pos(1));
            end
            if (Pos(2)+Size(2)-1)>size(MIAData.Data{1,1},2)
                Pos(2)=(size(MIAData.Data{1,1},2)-Size(2)+1);
                h.Mia_ROI_PosY.String=num2str(Pos(2));
            end
        case 2 %%% Image was clicked
            Type=h.Mia.SelectionType;
            switch Type
                case 'normal' %%% Centers on point
                    %%% Update Size
                    Size=round([str2double(h.Mia_ROI_SizeX.String) str2double(h.Mia_ROI_SizeY.String)]);
                    %%% Forces ROI size into bounds
                    if Size(1)>size(MIAData.Data{1,1},1) || Size(1)<1
                        Size(1)=size(MIAData.Data{1,1},1);
                        h.Mia_ROI_SizeX.String=num2str(Size(1));
                    end
                    if Size(2)>size(MIAData.Data{1,1},2) || Size(2)<1
                        Size(2)=size(MIAData.Data{1,1},2);
                        h.Mia_ROI_SizeY.String=num2str(Size(2));
                    end
                    %%% Updates position
                    Pos=round(e.Source.Parent.CurrentPoint(1,1:2)-Size/2);
                    h.Mia_ROI_PosX.String=num2str(Pos(1));
                    h.Mia_ROI_PosY.String=num2str(Pos(2));                    
                    %%% Forces ROI size into bounds
                    Pos(Pos<1)=1;
                    if (Pos(1)+Size(1)-1)>size(MIAData.Data{1,1},1)
                        Pos(1)=(size(MIAData.Data{1,1},1)-Size(1)+1);
                        h.Mia_ROI_PosX.String=num2str(Pos(1));
                    end
                    if (Pos(2)+Size(2)-1)>size(MIAData.Data{1,1},2)
                        Pos(2)=(size(MIAData.Data{1,1},2)-Size(2)+1);
                        h.Mia_ROI_PosY.String=num2str(Pos(2));
                    end
                case 'alt' %%%
                    %%% Turns off ROI during selection
                    h.Plots.ROI(1).Visible='off';
                    h.Plots.ROI(2).Visible='off';
                    %%% Determins selected area via dinamic box
                    Start=e.Source.Parent.CurrentPoint(1,1:2);
                    rbbox;
                    Stop=e.Source.Parent.CurrentPoint(1,1:2);
                    %%% Forces edges into bounds
                    if Stop(1)<e.Source.Parent.XLim(1)
                        Stop(1)=e.Source.Parent.XLim(1);
                    end
                    if Stop(1)>e.Source.Parent.XLim(2)
                        Stop(1)=e.Source.Parent.XLim(2);
                    end
                    if Stop(2)<e.Source.Parent.YLim(1)
                        Stop(2)=e.Source.Parent.YLim(1);
                    end
                    if Stop(2)>e.Source.Parent.YLim(2)
                        Stop(2)=e.Source.Parent.YLim(2);
                    end
                    %%% Updates position and size
                    Pos=[round(min(Start(1),Stop(1))+0.5) round(min(Start(2),Stop(2))+0.5)];
                    Size=[round(abs(Start(1)-Stop(1))) round(abs(Start(2)-Stop(2)))];
                    Size(Size<1)=1;
                    h.Mia_ROI_PosX.String=num2str(Pos(1));
                    h.Mia_ROI_PosY.String=num2str(Pos(2));                    
                    h.Mia_ROI_SizeX.String=num2str(Size(1));
                    h.Mia_ROI_SizeY.String=num2str(Size(2));
                    %%% Turns ROIs back on
                    h.Plots.ROI(1).Visible='on';
                    h.Plots.ROI(2).Visible='on';
                    
                    
                    
            end
    end

    %%% Updates ROI rectangles
    for i=1:2
        h.Plots.ROI(i).Position=[Pos-0.5 Size];
    end
    %%% Updates images
    Mia_Correct;
    
end





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Funtion to calculate correlations %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Do_2D_XCor(~,~)
h = guidata(findobj('Tag','Mia'));
global MIAData UserValues
h.Mia_Progress_Text.String = 'Correlating';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;

%%% Clears correlation data and plots
MIAData.Cor=cell(3,2);
for i=1:3
    h.Plots.Cor(i,1).CData=zeros(1,1,3);
    h.Plots.Cor(i,2).ZData=zeros(1);
    h.Plots.Cor(i,2).CData=zeros(1,1,3);    
    h.Mia_Cor_Axes(i,1).Visible='off';
    h.Mia_Cor_Axes(i,2).Visible='off';
    h.Mia_Cor_Axes(i,3).Visible='off';
    h.Plots.Cor(i,1).Visible='off';
    h.Plots.Cor(i,2).Visible='off';
    h.Plots.Cor(i,3).Visible='off';   
end
h.Mia_Cor_Frame_Slider.Min=0;
h.Mia_Cor_Frame_Slider.Max=0;
h.Mia_Cor_Frame_Slider.SliderStep=[1 1];
h.Mia_Cor_Frame_Slider.Value=0;

%%% Determins, which correlations to perform
if h.Mia_Correlation_Type.Value==3
    Auto=1:2; Cross=1;
    channel=1:3;
else
    Auto=h.Mia_Correlation_Type.Value; Cross=0;
    channel=floor(Auto*1.5);
end

%%% Determins, which frames to correlate
Frames=str2num(h.Mia_Correlation_Frames.String); %#ok<ST2NM> %%% Uses str2num, because the output is not scalar
%%% Uses all Frames, if input was 0
if all(Frames==0)
    Frames=1:size(MIAData.Data{1,2},3);
end
%%% Remove all Frames<1 and >Movie size
if any(Frames<0 | Frames>size(MIAData.Data{1,2},3));
    Min=max(1,min(Frames)); Min=min(Min,size(MIAData.Data{1,2},3));   
    Max=min(size(MIAData.Data{1,2},3),max(Frames)); Max=max(Max,1);
    Frames=Min:Max;
    h.Mia_Correlation_Frames.String=[num2str(Min) ':' num2str(Max)];
end

%%% Applies arbitrary region selection
switch (h.Mia_Correlation_FramesUse.Value)
    case 1
    case 2
        if Cross
            Active=find(prod(MIAData.Use));
        else
            Active=find(MIAData.Use(Auto,:));
        end
        Frames=intersect(Frames,Active);
    case 3
        %%% Does arbitrary region ICS
        %%% Uses Intensity and Variance thesholding to remove bad pixels
        %%% ROI borders
        From=h.Plots.ROI(1).Position(1:2)+0.5;
        To=From+h.Plots.ROI(1).Position(3:4)-1;
        %%% Thresholding Parameters
        Int_Max=str2double(h.Mia_Correlation_Int_Max.String);
        Int_Min=str2double(h.Mia_Correlation_Int_Min.String);
        Int_Fold_Max=str2double(h.Mia_Correlation_Int_Fold_Max.String);
        Int_Fold_Min=str2double(h.Mia_Correlation_Int_Fold_Min.String);
        Var_Fold_Max=str2double(h.Mia_Correlation_Var_Fold_Max.String);
        Var_Fold_Min=str2double(h.Mia_Correlation_Var_Fold_Min.String);
        Var_Sub=str2double(h.Mia_Correlation_Sub2.String);
        Var_SubSub=str2double(h.Mia_Correlation_Sub1.String);
        
        Use=cell(max(Auto),1);
        for i=Auto
            %% Static region intensity thresholding for arbitrary region ICS
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            %%% Because the intenities per pixel are very low, the tresholding
            %%% works on the sum of the stack
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            
            %%% Thresholding operates on summed up, uncorrected data
            Data=mean(double(MIAData.Data{i,1}(From(2):To(2),From(1):To(1),Frames)),3);
            %%% Logical array to determin which pixels to use
            Use{i}=true(size(Data));
            
            %%% Removes pixel below an intensity threshold set in kHz
            if Int_Min>0
                Use{i}(Data<Int_Min)=false;
            end
            %%% Removes pixel above an intensity threshold set in kHz
            if Int_Max>Int_Min
                Use{i}(Data>Int_Max)=false;
            end
            
            %% Sliding window thresholding for arbitrary region ICS
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            %%% The variance and itensity in a small rectangular region is
            %%% calculated and compared to the variance in a bigger region
            %%% around it
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            
            %%% Thresholding operates on uncorrected data
            Data=MIAData.Data{i,1}(From(2):To(2),From(1):To(1),Frames);
            %%% Exdents array to determine which pixels to use, because now
            %%% every frame is calculated individually
            Use{i}=repmat(Use{i},[1 1 size(Data,3)]);
            if Var_SubSub>1 && Var_Sub>Var_SubSub
                Start=ceil(Var_Sub/2)-1;
                Stop=floor(Var_Sub/2)-1;
                for j=1:size(Data,3)
                    Filter1=ones(Var_SubSub)/(Var_SubSub)^2;
                    Filter2=ones(Var_Sub)/(Var_Sub^2);
                    %%% Calculates population variance for both subregions                  (sample2population var)
                    Var1=(filter2(Filter1,Data(:,:,j).^2)-filter2(Filter1,Data(:,:,j)).^2)*(Var_SubSub^2/(Var_SubSub^2-1));
                    Var2=(filter2(Filter2,Data(:,:,j).^2)-filter2(Filter2,Data(:,:,j)).^2)*((Var_Sub^2)/(Var_Sub^2-1));
                    %%% Calculates mean of both subregions
                    Mean1=filter2(Filter1,Data(:,:,j));
                    Mean2=filter2(Filter2,Data(:,:,j));
                    %%% Discards samples with too low\high variance
                    if Var_Fold_Max>1
                        Use{i}(:,:,j)=Use{i}(:,:,j) & (Var1<(Var2*Var_Fold_Max));
                    end
                    if Var_Fold_Min<1 && Var_Fold_Min>0
                        Use{i}(:,:,j)=Use{i}(:,:,j) & (Var1>(Var2*Var_Fold_Min));
                    end
                    %%% Discards samples with too low\high intensities
                    if Int_Fold_Max>1
                        Use{i}(:,:,j)=Use{i}(:,:,j) & (Mean1<(Mean2*Int_Fold_Max));
                    end
                    if Int_Fold_Min<1 && Int_Fold_Min>0
                        Use{i}(:,:,j)=Use{i}(:,:,j) & (Mean1>(Mean2*Int_Fold_Min));
                    end
                end
                %%% Discards border pixels, where variance and intensity were not calculated
                Use{i}(1:Start,:,:)=false; Use{i}(:,1:Start,:)=false;
                Use{i}(end-Stop:end,:,:)=false; Use{i}(:,end-Stop:end,:)=false;
            end
            
            %%% Removes pixels, if invalid pixels were used for averaging
            if h.Mia_Add.Value==5 || h.Mia_Subtract.Value==4
                if h.Mia_Add.Value==5
                    Box1=[str2double(h.Mia_Add_Pixel.String), str2double(h.Mia_Add_Frames.String)];
                else
                    Box1=[1 1];
                end
                if h.Mia_Subtract.Value==4
                    Box2=[str2double(h.Mia_Subtract_Pixel.String), str2double(h.Mia_Subtract_Frames.String)];
                else
                    Box2=[1 1];
                end                               
                Box=max([Box1;Box2]);
                Filter=ones(Box(1),Box(1),Box(2))/(Box(1)^2*Box(2));
                Use{i}=logical(floor(imfilter(single(Use{i}),Filter,'replicate')));
            end
            
            MIAData.AR{i}=Use{i};
            Update_Plots([],[],1,i);
            clear Data;
        end
        
        
end



%%% Performs autocorrelation
for i=Auto
    MIAData.Cor{floor(i*1.5)}=zeros(size(MIAData.Data{1,2},1),size(MIAData.Data{1,2},2),numel(Frames));

    for j=1:numel(Frames)        
        Image=double(MIAData.Data{i,2}(:,:,Frames(j)));        
        if h.Mia_Correlation_FramesUse.Value==3  %%% Arbitrary region ICS            
            %%% Calculates normalization for zero regions            
            Norm=fft2(Use{i}(:,:,j));
            Norm=fftshift(ifft2(Norm.*conj(Norm)));
            %%% Calculates fluctutation image
            ImageFluct=Image-mean(Image(Use{i}(:,:,j)));
            %%% Applies selected region and FFT
            ImageFluct=fft2(ImageFluct.*Use{i}(:,:,j));
            %%% Actual correlation
            MIAData.Cor{floor(i*1.5)}(:,:,j)=fftshift(real(ifft2(ImageFluct.*conj(ImageFluct))))/(mean(Image(Use{i}(:,:,j)))^2);
            %%% Corrects for shape of selected region
            MIAData.Cor{floor(i*1.5)}(:,:,j)=MIAData.Cor{floor(i*1.5)}(:,:,j)./Norm;
            %%% Used to calculate total mean
            TotalInt(j)=sum(Image(Use{i}(:,:,j)));
            TotalPx(j)=numel(Image(Use{i}(:,:,j)));
        else %%% Standard ICS
            %%% Actual correlation            
            Image_FFT=fft2(Image);
            %%% Used to calculate total mean
            TotalInt(j)=sum(sum((Image)));
            TotalPx(j)=numel(Image);
            MIAData.Cor{floor(i*1.5)}(:,:,j)=(fftshift(real(ifft2(Image_FFT.*conj(Image_FFT))))/(mean2(Image)^2*size(Image,1)*size(Image,2))) - 1;
        end
        %%% Center point is average of x neighbors to remove noise peak
        center=[floor(size(MIAData.Cor{floor(i*1.5)},1)/2)+1,floor(size(MIAData.Cor{floor(i*1.5)},2)/2)+1];
        MIAData.Cor{floor(i*1.5)}(center(1),center(2),j)=(MIAData.Cor{floor(i*1.5)}(center(1),center(2)-1,j)+MIAData.Cor{floor(i*1.5)}(center(1),center(2)+1,j))/2;        
    end
    %%% Calculates mean intensity for saving
    MeanInt(i)=sum(TotalInt(j))/sum(TotalPx(j));
    clear Image ImageFluct;
end
%%% Performs crosscorrelation
if Cross
    MIAData.Cor{2}=zeros(size(MIAData.Data{1,2},1),size(MIAData.Data{1,2},2),numel(Frames));
    for j=i:numel(Frames)
        Image{1}=double(MIAData.Data{1,2}(:,:,Frames(j)));
        Image{2}=double(MIAData.Data{2,2}(:,:,Frames(j)));
        if h.Mia_Correlation_FramesUse.Value==3  %%% Arbitrary region ICS
            %%% Calculates normalization for zero regions
            Norm=fft2(Use{1}(:,:,j).*Use{2}(:,:,j));
            Norm=fftshift(ifft2(Norm.*conj(Norm)));
            %%% Calculates fluctutation image
            ImageFluct{1}=Image{1}-mean(Image{1}(Use{1}(:,:,j) & Use{2}(:,:,j)));
            ImageFluct{2}=Image{2}-mean(Image{2}(Use{1}(:,:,j) & Use{2}(:,:,j)));
            %%% Applies selected region and FFT
            ImageFluct{1}=fft2(ImageFluct{1}.*(Use{1}(:,:,j) & Use{2}(:,:,j)));
            ImageFluct{2}=fft2(ImageFluct{2}.*(Use{1}(:,:,j) & Use{2}(:,:,j)));
            %%% Actual correlation
            MIAData.Cor{2}(:,:,j)=fftshift(real(ifft2(ImageFluct{1}.*conj(ImageFluct{2}))))/(mean(Image{1}(Use{1}(:,:,j) & Use{2}(:,:,j)))*mean(Image{2}(Use{1}(:,:,j) & Use{2}(:,:,j))));
            %%% Corrects for shape of selected region
            MIAData.Cor{2}(:,:,j)=MIAData.Cor{2}(:,:,j)./Norm;         
        else
            %%% Actual correlation
            MIAData.Cor{2}(:,:,j)=(fftshift(real(ifft2(fft2(Image{1}).*conj(fft2(Image{2})))))/(mean2(Image{1})*mean2(Image{2})*size(Image{1},1)*size(Image{1},2))) - 1;
        end
        %%% Center point is average of x neighbors to remove noise peak
        center=[floor(size(MIAData.Cor{2},1)/2)+1,floor(size(MIAData.Cor{2},2)/2)+1];
        MIAData.Cor{2}(center(1),center(2),j)=(MIAData.Cor{2}(center(1),center(2)-1,j)+MIAData.Cor{2}(center(1),center(2)+1,j))/2;
    end
end
clear Image ImageFluct;
%%% Corrects the amplitude changes due to temporal moving average addition/subtraction
%%% The Formula assumes 2 or 3 species with different brightnesses and corrects the amplitude accordingly
if h.Mia_Add.Value==5 && h.Mia_Subtract.Value==4 %%% Subtracts and Adds moving average
    Sub=str2double(h.Mia_Subtract_Frames.String);
    Add=str2double(h.Mia_Add_Frames.String);
    if Sub~=Add %%% If Add==Sub, nothing was done        
        Correct=1/((1+1/Add-1/Sub)^2+(1/Add-1/Sub)^2*(min(Add,Sub)-1)+(1/max(Add,Sub))^2*abs(Add-Sub));
    else %%% If Add==Sub, nothing was done
        Correct=1;
    end
elseif h.Mia_Add.Value==5
    Add=str2double(h.Mia_Add_Frames.String); 
    Correct=1/((1+1/Add)^2+(1/Add)^2*(Add-1));
elseif h.Mia_Subtract.Value==4
    Sub=str2double(h.Mia_Subtract_Frames.String);
    Correct=1/((1-1/Sub)^2+(1/Sub)^2*(Sub-1));
else
    Correct=1;
end
%%% Applies amplidute correction
for i=1:size(MIAData.Cor)
    if ~isempty(MIAData.Cor{i})
        MIAData.Cor{i}=MIAData.Cor{i}*Correct;
    end
end

%%% Saves correlation files
if h.Mia_Correlation_Save.Value > 1
    DataAll=cell(3,2);
    InfoAll = struct;
    %% Gets auto correlations data to save
    for i = Auto        
        %%% File name information
        InfoAll(i).File = MIAData.FileName{i};
        InfoAll(i).Path = UserValues.File.MIAPath;
        %%% ROI and TOI
        InfoAll(i).Frames = Frames;
        From = h.Plots.ROI(1).Position(1:2)+0.5;
        To = From+h.Plots.ROI(1).Position(3:4)-1;
        InfoAll(i).ROI = [From To];
        %%% Pixel [µs], Line [ms] and Frametime [s]
        InfoAll(i).Times = [str2double(h.Mia_Image_Pixel.String) str2double(h.Mia_Image_Line.String) str2double(h.Mia_Image_Frame.String)];
        %%% Pixel size
        InfoAll(i).Size = str2double(h.Mia_Image_Size.String);
        %%% Correction information
        InfoAll(i).Correction.SubType = h.Mia_Subtract.String{h.Mia_Subtract.Value};
        if h.Mia_Subtract.Value == 4
            InfoAll(i).Correction.SubROI = [str2double(h.Mia_Subtract_Pixel.String) str2double(h.Mia_Subtract_Frames.String)];
        end
        InfoAll(i).Correction.AddType = h.Mia_Add.String{h.Mia_Add.Value};
        if h.Mia_Add.Value == 5
            InfoAll(i).Correction.AddROI = [str2double(h.Mia_Add_Pixel.String) str2double(h.Mia_Add_Frames.String)];
        end
        %%% Correlation Type (Arbitrary region == 3)
        InfoAll(i).Type = h.Mia_Correlation_FramesUse.String{h.Mia_Correlation_FramesUse.Value};
        switch h.Mia_Correlation_FramesUse.Value
            case [1 2] %%% All/Selected frames
                %%% Mean intensity [counts]
                InfoAll(i).Mean = mean2(double(MIAData.Data{i,2}(:,:,Frames)));
                InfoAll(i).AR = [];
            case 3 %%% Arbitrary region
                %%% Mean intensity of selected pixels [counts]
                Image = double(MIAData.Data{i,2}(:,:,Frames));
                InfoAll(i).Mean = mean(Image(Use{i}));
                %%% Arbitrary region information
                InfoAll(i).AR.Int_Max = str2double(h.Mia_Correlation_Int_Max.String);
                InfoAll(i).AR.Int_Min = str2double(h.Mia_Correlation_Int_Min.String);
                InfoAll(i).AR.Int_Fold_Max = str2double(h.Mia_Correlation_Int_Fold_Max.String);
                InfoAll(i).AR.Int_Fold_Min = str2double(h.Mia_Correlation_Int_Fold_Min.String);
                InfoAll(i).AR.Var_Fold_Max = str2double(h.Mia_Correlation_Var_Fold_Max.String);
                InfoAll(i).AR.Var_Fold_Min = str2double(h.Mia_Correlation_Var_Fold_Min.String);
                InfoAll(i).AR.Var_Sub=str2double(h.Mia_Correlation_Sub2.String);
                InfoAll(i).AR.Var_SubSub=str2double(h.Mia_Correlation_Sub1.String);
        end
        %%% Mean intensity
        InfoAll(i).Counts = MeanInt(i);     
        %%% Averaged correlation
        DataAll{i,1} = mean(MIAData.Cor{floor(1.5*i),1},3);
        %%% Error of correlation
        DataAll{i,2} = std(MIAData.Cor{floor(1.5*i),1},0,3);
        

    end
    %% Gets cross correlation data to save
    if Cross == 1
        %%% File name information
        InfoAll(3).File = MIAData.FileName{1};
        InfoAll(3).Path = UserValues.File.MIAPath;
        %%% ROI and TOI
        InfoAll(3).Frames = Frames;
        From=h.Plots.ROI(1).Position(1:2)+0.5;
        To=From+h.Plots.ROI(1).Position(3:4)-1;
        InfoAll(3).ROI = [From To];
        %%% Pixel [µs], Line [ms] and Frametime [s]
        InfoAll(3).Times = [str2double(h.Mia_Image_Pixel.String) str2double(h.Mia_Image_Line.String) str2double(h.Mia_Image_Frame.String)];
        %%% Pixel size
        InfoAll(3).Size = str2double(h.Mia_Image_Size.String);
        %%% Correction information
        InfoAll(3).Correction.SubType = h.Mia_Subtract.String{h.Mia_Subtract.Value};
        if h.Mia_Subtract.Value == 4
            InfoAll(3).Correction.SubROI = [str2double(h.Mia_Subtract_Pixel.String) str2double(h.Mia_Subtract_Frames.String)];
        end
        InfoAll(3).Correction.AddType = h.Mia_Add.String{h.Mia_Add.Value};
        if h.Mia_Add.Value == 5
            InfoAll(3).Correction.AddROI = [str2double(h.Mia_Add_Pixel.String) str2double(h.Mia_Add_Frames.String)];
        end
        %%% Correlation Type (Arbitrary region == 3)
        InfoAll(3).Type = h.Mia_Correlation_Type.String{h.Mia_Correlation_Type.Value};
        switch h.Mia_Correlation_FramesUse.Value
            case [1 2] %%% All/Selected frames
                %%% Mean intensity [counts]
                InfoAll(3).Mean = (mean2(double(MIAData.Data{1,2}(:,:,Frames))) + mean2(double(MIAData.Data{2,2}(:,:,Frames))))/2;
                InfoAll(3).AR = [];
            case 3 %%% Arbitrary region
                %%% Mean intensity of selected pixels [counts]
                Image1 = double(MIAData.Data{1,2}(:,:,Frames));
                Image2 = double(MIAData.Data{2,2}(:,:,Frames));
                InfoAll(3).Mean = (mean(Image1(Use{1} & Use{2})) + mean(Image2(Use{1} & Use{2})))/2;
                %%% Arbitrary region information
                InfoAll(3).AR.Int_Max = str2double(h.Mia_Correlation_Int_Max.String);
                InfoAll(3).AR.Int_Min = str2double(h.Mia_Correlation_Int_Min.String);
                InfoAll(3).AR.Int_Fold_Max = str2double(h.Mia_Correlation_Int_Fold_Max.String);
                InfoAll(3).AR.Int_Fold_Min = str2double(h.Mia_Correlation_Int_Fold_Min.String);
                InfoAll(3).AR.Var_Fold_Max = str2double(h.Mia_Correlation_Var_Fold_Max.String);
                InfoAll(3).AR.Var_Fold_Min = str2double(h.Mia_Correlation_Var_Fold_Min.String);
                InfoAll(3).AR.Var_Sub=str2double(h.Mia_Correlation_Sub2.String);
                InfoAll(3).AR.Var_SubSub=str2double(h.Mia_Correlation_Sub1.String);
        end
        %%% Mean intensity
        InfoAll(3).Counts = sum(MeanInt);
        %%% Averaged correlation
        DataAll{3,1} = mean(MIAData.Cor{2,1},3);
        %%% Error of correlation
        DataAll{3,2} = std(MIAData.Cor{2,1},0,3);
    end
    %% Saves correlations
    switch h.Mia_Correlation_Save.Value
        case 2 %%% .miacor filetype
            %% Creates new filename
            %%% Removes file extension
            switch MIAData.Type
                case 1
                    FileName=MIAData.FileName{1}{1}(1:end-4);
            end
            %%% Generates filename
            Current_FileName1=fullfile(UserValues.File.MIAPath,[FileName '_ACF1.miacor']);
            Current_FileName2=fullfile(UserValues.File.MIAPath,[FileName '_ACF2.miacor']);
            Current_FileName3=fullfile(UserValues.File.MIAPath,[FileName '_CCF.miacor']);
            %%% Checks, if file already exists and create new filename
            if  exist(Current_FileName1,'file')  || exist(Current_FileName2,'file') || exist(Current_FileName3,'file')
                k=1;
                %%% Adds 1 to filename
                Current_FileName1=[Current_FileName1(1:end-7) '_' num2str(k) '.miacor'];
                Current_FileName2=[Current_FileName2(1:end-7) '_' num2str(k) '.miacor'];
                Current_FileName3=[Current_FileName3(1:end-7) '_' num2str(k) '.miacor'];
                %%% Increases counter, until no file is found
                while exist(Current_FileName1,'file')  || exist(Current_FileName2,'file') || exist(Current_FileName3,'file')
                    k=k+1;
                    Current_FileName1=[Current_FileName1(1:end-(7+numel(num2str(k-1)))) num2str(k) '.miacor'];
                    Current_FileName2=[Current_FileName2(1:end-(7+numel(num2str(k-1)))) num2str(k) '.miacor'];
                    Current_FileName3=[Current_FileName3(1:end-(7+numel(num2str(k-1)))) num2str(k) '.miacor'];
                end
            end
            %%% Saves Auto correlations
            for i=Auto
                Info = InfoAll(i); %#ok<NASGU>
                Data = DataAll(i,:); %#ok<NASGU>
                if i==1
                    save(Current_FileName1,'Info','Data');
                else
                    save(Current_FileName2,'Info','Data');
                end
            end
            %%% Saves Cross correlations
            if Cross
                Info = InfoAll(3); %#ok<NASGU>
                Data = DataAll(3,:); %#ok<NASGU>
                save(Current_FileName3,'Info','Data');
            end            
        case 3 %%% .tif + .txt files
            %% Creates new filename
            %%% Removes file extension
            switch MIAData.Type
                case 1
                    FileName=MIAData.FileName{1}{1}(1:end-4);
            end
            %%% Generates filename
            Current_FileName1=fullfile(UserValues.File.MIAPath,[FileName '_ACF1.tif']);
            Current_FileName2=fullfile(UserValues.File.MIAPath,[FileName '_ACF2.tif']);
            Current_FileName3=fullfile(UserValues.File.MIAPath,[FileName '_CCF.tif']);
            Current_FileName4=fullfile(UserValues.File.MIAPath,[FileName '_Info.txt']);
            %%% Checks, if file already exists and create new filename
            if  exist(Current_FileName1,'file')  || exist(Current_FileName2,'file') || exist(Current_FileName3,'file') || exist(Current_FileName4,'file')
                k=1;
                %%% Adds 1 to filename
                Current_FileName1=[Current_FileName1(1:end-4) '_' num2str(k) '.tif'];
                Current_FileName2=[Current_FileName2(1:end-4) '_' num2str(k) '.tif'];
                Current_FileName3=[Current_FileName3(1:end-4) '_' num2str(k) '.tif'];
                Current_FileName4=[Current_FileName4(1:end-4) '_' num2str(k) '.txt'];
                %%% Increases counter, until no file is found
                while exist(Current_FileName1,'file')  || exist(Current_FileName2,'file') || exist(Current_FileName3,'file')
                    k=k+1;
                    Current_FileName1=[Current_FileName1(1:end-(4+numel(num2str(k-1)))) num2str(k) '.tif'];
                    Current_FileName2=[Current_FileName2(1:end-(4+numel(num2str(k-1)))) num2str(k) '.tif'];
                    Current_FileName3=[Current_FileName3(1:end-(4+numel(num2str(k-1)))) num2str(k) '.tif'];
                    Current_FileName4=[Current_FileName4(1:end-(4+numel(num2str(k-1)))) num2str(k) '.txt'];
                end
            end
            %% Saves info file
            FID = fopen(Current_FileName4,'w');
            if Cross
                Info = InfoAll(3);
            else
                Info = InfoAll(Auto);
            end
            fprintf(FID,'%s\n','Image Correlation info file');
            %%% Pixel\Line\Frame times
            fprintf(FID,'%s\t%f\n', 'Pixel time [µs]:',Info.Times(1));
            fprintf(FID,'%s\t%f\n', 'Line  time [ms]:',Info.Times(2));
            fprintf(FID,'%s\t%f\n', 'Frame time [s] :',Info.Times(3));
            %%% Pixel size
            fprintf(FID,'%s\t%f\n', 'Pixel size [nm]:',Info.Size);
            %%% Region of interest
            fprintf(FID,'%s\t%u,%u,%u,%u\t%s\n', 'Region used [px]:',Info.ROI, 'X Start, Y Start, X Stop, Y Stop');
            %%% Counts per pixel
            fprintf(FID,'%s\t%f\n', 'Mean counts per pixel:',Info.Counts);
            %%% Frames used
            fprintf(FID,['%s\t',repmat('%u\t',[1 numel(Info.Frames)]) '\n'],'Frames Used:',Info.Frames);
            %%% Subtraction used
            switch h.Mia_Subtract.Value
                case 1
                    fprintf(FID,'%s\n','Nothing subtracted');
                case 2
                    fprintf(FID,'%s\n','Frame mean subtracted');
                case 3
                    fprintf(FID,'%s\n','Pixel mean subtracted');
                case 4
                    fprintf(FID,'%s\t%u%s\t%u%s\n','Moving average subtracted:', InfoAll(i).Correction.SubROI(1), ' Pixel', InfoAll(i).Correction.SubROI(2),' Frames');
            end
            %%% Addition used
            switch h.Mia_Subtract.Value
                case 1
                    fprintf(FID,'%s\n','Nothing added');
                case 2
                    fprintf(FID,'%s\n','Total mean added');
                case 3
                    fprintf(FID,'%s\n','Frame mean added');
                case 4
                    fprintf(FID,'%s\n','Pixel mean added');
                case 5
                    fprintf(FID,'%s\t%u%s%u%s\n','Moving average added:', InfoAll(i).Correction.SubROI(1), ' Pixel', InfoAll(i).Correction.SubROI(2),' Frames');
            end
            %%% Arbitrary region
            if h.Mia_Correlation_FramesUse.Value==3
                fprintf(FID,'%s\n','Arbitrary region used:');
                fprintf(FID,'%s\t%f\n','Minimal average intensity [kHz]:',InfoAll(i).AR.Int_Min);
                fprintf(FID,'%s\t%f\n','Maximal average intensity [kHz]:',InfoAll(i).AR.Int_Max);
                fprintf(FID,'%s\t%u,%u\n','Subregions size:',InfoAll(i).AR.Var_SubSub,InfoAll(i).AR.Var_Sub);
                fprintf(FID,'%s\t%f,%f\n','Minimal\Maximal intensity deviation:',InfoAll(i).AR.Int_Fold_Min,InfoAll(i).AR.Int_Fold_Max);
                fprintf(FID,'%s\t%f,%f\n','Minimal\Maximal variance deviation:',InfoAll(i).AR.Var_Fold_Min,InfoAll(i).AR.Var_Fold_Max);

            end            
            fclose(FID);           
            %% Saves correlation TIFFs
            for i=Auto
                %%% Resizes double to 16bit uint
                Data{1} = DataAll{i,1};
                Min(1) = min(min(Data{1}));
                Max(1) = max(max(Data{1}));
                Data{1} = uint16(2^16*(Data{1}-Min(1))/(Max(1)-Min(1)));
                Data{2} = DataAll{i,2};
                Min(2) = min(min(Data{2}));
                Max(2) = max(max(Data{2}));
                Data{2} = uint16(2^16*(Data{2}-Min(2))/(Max(2)-Min(2)));                
                %%% Creates header information
                TiffStruct.ImageWidth = size(Data{1},2);
                TiffStruct.ImageLength = size(Data{1},1);
                TiffStruct.BitsPerSample = 16;
                TiffStruct.Photometric = Tiff.Photometric.MinIsBlack;
                TiffStruct.Compression = Tiff.Compression.LZW;
                TiffStruct.PlanarConfiguration = Tiff.PlanarConfiguration.Chunky;
                TiffStruct.ImageDescription = num2str([round(2^16/(Max(1)-Min(1))), Min(1), InfoAll(i).Counts, InfoAll(i).Times(1)]);
                %%% Creates new TIFF file
                if i==1
                    
                    t = Tiff(Current_FileName1,'w');                   
                else
                    t = Tiff(Current_FileName2,'w');
                end
                %%% Saves correlation as 2 frames (Cor and Error)
                t.setTag(TiffStruct);
                t.write(Data{1});
                t.writeDirectory();
                TiffStruct.ImageDescription = num2str([round(2^16/(Max(1)-Min(1))), Min(1), InfoAll(i).Counts, InfoAll(i).Times(1)]);
                t.setTag(TiffStruct);
                t.write(Data{2});
                t.close();
            end
            if Cross
                %%% Resizes double to 16bit uint
                Data{1} = DataAll{3,1};
                Min(1) = min(min(Data{1}));
                Max(1) = max(max(Data{1}));
                Data{1} = uint16(2^16*(Data{1}-Min(1))/(Max(1)-Min(1)));
                Data{2} = DataAll{i,2};
                Min(2) = min(min(Data{2}));
                Max(2) = max(max(Data{2}));
                Data{2} = uint16(2^16*(Data{2}-Min(2))/(Max(2)-Min(2)));                
                %%% Creates header information
                TiffStruct.ImageWidth = size(Data{1},2);
                TiffStruct.ImageLength = size(Data{1},1);
                TiffStruct.BitsPerSample = 16;
                TiffStruct.Photometric = Tiff.Photometric.MinIsBlack;
                TiffStruct.Compression = Tiff.Compression.LZW;
                TiffStruct.PlanarConfiguration = Tiff.PlanarConfiguration.Chunky;
                TiffStruct.ImageDescription = num2str([round(2^16/(Max(1)-Min(1))), Min(1), InfoAll(3).Counts, InfoAll(3).Times(1)]);
                %%% Creates new TIFF file
                t = Tiff(Current_FileName3,'w');
                %%% Saves correlation as 2 frames (Cor and Error)
                t.setTag(TiffStruct);
                t.write(Data{1});
                t.writeDirectory();
                TiffStruct.ImageDescription = num2str([round(2^16/(Max(2)-Min(2))), Min(2)]);
                t.setTag(TiffStruct);
                t.write(Data{2});
                t.close();          
            end
            
        otherwise
    end

end


for i=channel
    h.Mia_Cor_Axes(i,1).Visible='on';
    h.Mia_Cor_Axes(i,2).Visible='on';
    h.Mia_Cor_Axes(i,3).Visible='on';
    h.Plots.Cor(i,1).Visible='on';
    h.Plots.Cor(i,2).Visible='on';
    h.Plots.Cor(i,3).Visible='on';
end

%%% Updates correlation frame slider
i=channel(1);
h.Mia_Cor_Frame_Slider.Min=0;
h.Mia_Cor_Frame_Slider.Max=size(MIAData.Cor{i},3);
h.Mia_Cor_Frame_Slider.SliderStep=[1./(size(MIAData.Cor{i},3)+1),10/(size(MIAData.Cor{i},3)+1)];
h.Mia_Cor_Frame_Slider.Value=0;
h.Mia_Cor_Frames2Use.String=['1:' num2str(size(MIAData.Cor{i},3))];

%%% Updates correlation plots

Update_Plots([],[],2,channel);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Peforms rics fit %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Do_RICS_Fit(~,~,mode)
global MIAData
h = guidata(findobj('Tag','Mia'));
h.Mia_Progress_Text.String = 'Fitting correlation';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;

%%% Extracts parameters and data
NotFixed=find(~cell2mat(h.Mia_Cor_Fit_Table.Data(2:2:end,mode)));
Params=cellfun(@str2double,h.Mia_Cor_Fit_Table.Data(1:2:end,mode));
Fit_Params=Params(NotFixed);
YData=h.Plots.Cor(mode,2).ZData;
Size=str2double(h.Mia_Cor_Size.String);  
if str2double(h.Mia_Cor_Frame.String)==0
    %%% Extracts, what frames to use
    Frames=str2num(h.Mia_Cor_Frames2Use.String);     %#ok<ST2NM>
    %%% Calculate borders
    X(1)=ceil(floor(size(MIAData.Cor{mode,1},1)/2)-Size/2)+1;
    X(2)=ceil(floor(size(MIAData.Cor{mode,1},1)/2)+Size/2);
    Y(1)=ceil(floor(size(MIAData.Cor{mode,1},2)/2)-Size/2)+1;
    Y(2)=ceil(floor(size(MIAData.Cor{mode,1},2)/2)+Size/2);
    %%% calculates SEM
    SEM=std(double(MIAData.Cor{mode,1}(X(1):X(2),Y(1):Y(2),Frames)),0,3)/sqrt(numel(Frames));
else
    SEM=ones(size(YData));
end
if any(any(SEM==0));
    SEM=1;
end

%%%
opts=optimset('Display','off');
%%% Performas fit
[Fitted_Params,~,~,~]=lsqcurvefit(@Fit_RICS,Fit_Params,{Params,NotFixed,Size,SEM(:)},YData(:)./SEM(:),[],[],opts);
%%% Updates parameters and table
Params(NotFixed)=Fitted_Params;
h.Mia_Cor_Fit_Table.Data(1:2:end,mode)=deal(cellfun(@num2str,num2cell(Params),'UniformOutput',false));
%%% Calculates fit function
Calc_RICS_Fit(mode);
%%% Updates correlation plots
Update_Plots([],[],2,mode);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% RICS fit function %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function [OUT]=Fit_RICS(Fit_Params,Data)

Shift=floor(Data{3}/2)+1;
[X,Y]=meshgrid(1:Data{3},1:Data{3});
X=X(:); Y=Y(:);
SEM=Data{4};

P=Data{1};
P(Data{2})=Fit_Params;

OUT= P(5) + 2.^(-3./2)./P(1).... %%% Amplitude
    .*(1+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3)/(P(3)*10^-6)^2).^(-1)... %%% XY Diffusion
    .*(1+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3)/(P(4)*10^-6)^2).^(-0.5)... %%% Z Diffusion
    .*exp(-(P(6)*10^-9)^2*((X-Shift).^2+(Y-Shift).^2)./((P(3)*10^-6)^2+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3))); %%% Scanning
OUT((Shift-1)*(Data{3}+1)+1)=(OUT((Shift-1)*(Data{3}-1))+OUT(Shift*(Data{3}+1)))/2;
OUT=OUT./SEM;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Calculates fit function without fitting %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%       
function [OUT]=Calc_RICS_Fit(mode)
global MIAData
h = guidata(findobj('Tag','Mia'));
P=cellfun(@str2double,h.Mia_Cor_Fit_Table.Data(1:2:end,mode));
Size=str2double(h.Mia_Cor_Size.String);

Shift=floor(Size/2)+1;
[X,Y]=meshgrid(1:Size,1:Size);
X=X(:); Y=Y(:);

OUT= P(5) + 2.^(-3./2)./P(1).... %%% Amplitude
    .*(1+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3)/(P(3)*10^-6)^2).^(-1)... %%% XY Diffusion
    .*(1+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3)/(P(4)*10^-6)^2).^(-0.5)... %%% Z Diffusion
    .*exp(-(P(6)*10^-9)^2*((X-Shift).^2+(Y-Shift).^2)./((P(3)*10^-6)^2+4*P(2)*10^-12*(abs(X-Shift)*P(7)*10^-6+abs(Y-Shift)*P(8)*10^-3))); %%% Scanning
OUT((Shift-1)*(Size+1)+1)=(OUT((Shift-1)*(Size-1))+OUT(Shift*(Size+1)))/2;
MIAData.Cor{mode,2}=reshape(OUT,[Size,Size]);





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Funtion to calculate correlations %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function Do_NB(~,~)
h = guidata(findobj('Tag','Mia'));
global MIAData

h.Mia_Progress_Text.String = 'Calculating N&B';
h.Mia_Progress_Axes.Color=[1 0 0];  
drawnow;

MIAData.NB=[];

%% Determins, for which channels to calculate
if h.Mia_NB_Type.Value==3
    Auto=1:2; Cross=1;
    channel=1:3;
else
    Auto=h.Mia_NB_Type.Value; Cross=0;
    channel=floor(Auto*1.5);
end

%% Calculates N&B
for i=Auto
    %%% Limit for PCH
    MaxPhotons=ceil(max(max(max(MIAData.Data{floor(i),2}))));
    %%% Calculaces PCH, mean intensity, standard deviation for each pixel
    MIAData.NB.PCH{floor(i*1.5)}=histc(MIAData.Data{i,2}(:),0:MaxPhotons); 
    MIAData.NB.Int{floor(i*1.5)}=mean(MIAData.Data{i,2},3);
    MIAData.NB.Std{floor(i*1.5)}=std(MIAData.Data{i,2},0,3);
    %%% Applies spacial filter to intensity and standard deviation
    if str2double(h.Mia_NB_Average_Diameter.String)<=1
        h.Mia_NB_Average.Value=1;
    end
    %%% Determinesspatial filter
    switch h.Mia_NB_Average.Value
        case 1 %%% Do nothing
            Filter = fspecial('average',1);
        case 2 %%% Moving average
            Filter = fspecial('average',round(str2double(h.Mia_NB_Average_Diameter.String)));
        case 3 %%% Disc average
            Filter = fspecial('disk',str2double(h.Mia_NB_Average_Diameter.String)-1);
        case 4 %%% Gaussian average
            Filter = fspecial('gaussian',2*str2double(h.Mia_NB_Average_Diameter.String),str2double(h.Mia_NB_Average_Diameter.String)/2);
    end
    %%% Applies filter
    MIAData.NB.Int{floor(i*1.5)}=imfilter(MIAData.NB.Int{floor(i*1.5)},Filter,'symmetric');
    MIAData.NB.Std{floor(i*1.5)}=imfilter(MIAData.NB.Std{floor(i*1.5)},Filter,'symmetric');
    %%% Calculates number and brightness for each pixel
    MIAData.NB.Num{floor(i*1.5)}=MIAData.NB.Int{floor(i*1.5)}.^2./(MIAData.NB.Std{floor(i*1.5)}.^2-MIAData.NB.Int{floor(i*1.5)})/sqrt(8);
    MIAData.NB.Eps{floor(i*1.5)}=(MIAData.NB.Std{floor(i*1.5)}.^2-MIAData.NB.Int{floor(i*1.5)})./MIAData.NB.Int{floor(i*1.5)}*sqrt(8);
   
end

%% Calculates crossN&B
if Cross
    MaxPhotons=ceil(max(max(max(MIAData.Data{1,2}+MIAData.Data{2,2}))));
    %%% Calculaces PCH, mean intensity, standard deviation for each pixel
    MIAData.NB.PCH{2}=histc(MIAData.Data{1,2}(:)+MIAData.Data{2,2}(:),0:MaxPhotons); %%% PCH of sum of channels
    MIAData.NB.Int{2}=sqrt(MIAData.NB.Int{1}.*MIAData.NB.Int{3}); %%% sqrt of product to be able to calculate N&B
    MIAData.NB.Std{2}=sqrt(mean((MIAData.Data{1,2}-repmat(mean(MIAData.Data{1,2},3),[1 1,size(MIAData.Data{1,2},3)]))...
                                 .*(MIAData.Data{2,2}-repmat(mean(MIAData.Data{2,2},3),[1 1,size(MIAData.Data{2,2},3)])),3)); %%% sqrt of co-variance
    %%% Applies spacial filter to intensity and standard deviation
    if str2double(h.Mia_NB_Average_Diameter.String)<=1
        h.Mia_NB_Average.Value=1;
    end
    %%% Determinesspatial filter
    switch h.Mia_NB_Average.Value
        case 1 %%% Do nothing
            Filter = fspecial('average',1);
        case 2 %%% Moving average
            Filter = fspecial('average',round(str2double(h.Mia_NB_Average_Diameter.String)));
        case 3 %%% Disc average
            Filter = fspecial('disk',str2double(h.Mia_NB_Average_Diameter.String)-1);
        case 4 %%% Gaussian average
            Filter = fspecial('gaussian',2*str2double(h.Mia_NB_Average_Diameter.String),str2double(h.Mia_NB_Average_Diameter.String)/2);
    end
    %%% Applies filter
    MIAData.NB.Int{floor(2)}=imfilter(MIAData.NB.Int{floor(2)},Filter,'symmetric');
    MIAData.NB.Std{floor(2)}=imfilter(MIAData.NB.Std{floor(2)},Filter,'symmetric');
    %%% Calculates number and brightness for each pixel
    MIAData.NB.Num{2}=real(MIAData.NB.Int{2}.^2./(MIAData.NB.Std{2}.^2));
    MIAData.NB.Eps{2}=real((MIAData.NB.Std{2}.^2)./MIAData.NB.Int{2}); 
end

i=channel(1);

%% Uses first active channel to initiate standard threshold parameters
%%% Uses actual min/max of mean+-3sigma for intensity
h.Mia_NB_Hist(1,1).String=num2str(max([min(MIAData.NB.Int{i}(:)), mean2(MIAData.NB.Int{i})-3*mean2(MIAData.NB.Std{i})])/str2double(h.Mia_NB_Pixel.String)*10^3);
h.Mia_NB_Hist(2,1).String=num2str(min([max(MIAData.NB.Int{i}(:)), mean2(MIAData.NB.Int{i})+3*mean2(MIAData.NB.Std{i})])/str2double(h.Mia_NB_Pixel.String)*10^3);
h.Mia_NB_Hist(3,1).String='50';

%%%  Removes 5% of top and bottom values to remove outliers 
NoOutliers=sort(MIAData.NB.Num{i}(:));
NoOutliers=NoOutliers(round(0.05*numel(NoOutliers)):round(0.95*numel(NoOutliers)));
%%% mena+-3sigma for number
h.Mia_NB_Hist(1,2).String=num2str(mean(NoOutliers)-3*std(NoOutliers));
h.Mia_NB_Hist(2,2).String=num2str(mean(NoOutliers)+3*std(NoOutliers));
h.Mia_NB_Hist(3,2).String='50';

%%%  Removes 5% of top and bottom values to remove outliers 
NoOutliers=sort(MIAData.NB.Eps{i}(:));
NoOutliers=NoOutliers(round(0.05*numel(NoOutliers)):round(0.95*numel(NoOutliers)));
%%% mena+-3sigma for brightness
h.Mia_NB_Hist(1,3).String=num2str((mean(NoOutliers)-3*std(NoOutliers))/str2double(h.Mia_NB_Pixel.String)*10^3);
h.Mia_NB_Hist(2,3).String=num2str((mean(NoOutliers)+3*std(NoOutliers))/str2double(h.Mia_NB_Pixel.String)*10^3);
h.Mia_NB_Hist(3,3).String='50';

%%% Updates N&B plots
Update_Plots([],[],3,channel);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Changes 2D histogram background color %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function NB_2DHist_BG(~,~)
h = guidata(findobj('Tag','Mia'));
h.Mia_NB_2DHist(3).BackgroundColor=1-h.Mia_NB_2DHist(3).BackgroundColor;
h.Mia_NB_2DHist(3).ForegroundColor=1-h.Mia_NB_2DHist(3).ForegroundColor;
Update_Plots([],[],3,1:3)